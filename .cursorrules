# 02LUKA System - Cursor AI Rules
# Updated: 2025-12-14
# SOT Path: /Users/icmini/02luka
#
# ⚠️ FUNDAMENTAL WORKING METHOD:
# - Always dry-run and verify before claiming success
# - Never overclaim without evidence
# - See "Development Workflow Protocol" section below

## System Architecture

**Single Source of Truth (SOT):**
- Main: `/Users/icmini/02luka`
- Working: `/Users/icmini/02luka/g`
- Legacy symlink: `/Users/icmini/LocalProjects/02luka_local_g` → `/Users/icmini/02luka`

**Key Directories:**
- Tools: `~/02luka/tools/`
- Agents: `~/02luka/agents/`
- Config: `~/02luka/config/`
- Logs: `~/02luka/logs/`
- Reports: `~/02luka/g/reports/`
- Sessions: `~/02luka/g/reports/sessions/`

## Environment Variables

Always use these paths:
```bash
LUKA_SOT="/Users/icmini/02luka"
LUKA_HOME="/Users/icmini/02luka/g"
SOT_PATH="/Users/icmini/02luka/g"
```

## Coding Guidelines

1. **File Operations:**
   - Always use absolute paths starting with `/Users/icmini/02luka`
   - Never use relative paths across major directories
   - Check file existence before operations

2. **Scripting:**
   - Use `#!/usr/bin/env zsh` for shell scripts
   - Always include `set -euo pipefail` for safety
   - Store executables in `~/02luka/tools/`

3. **LaunchAgents:**
   - Store plists in `~/Library/LaunchAgents/`
   - Use naming: `com.02luka.<service>.plist`
   - Always include: KeepAlive, RunAtLoad, ThrottleInterval
   - Logs to: `~/02luka/logs/<service>.stdout.log`

4. **Documentation:**
   - Session reports: `~/02luka/g/reports/sessions/`
   - System docs: `~/02luka/02luka.md`
   - Roadmaps: `~/02luka/g/roadmaps/`
   - MLS lessons: `~/02luka/g/knowledge/mls_lessons.jsonl`

## Redis Infrastructure

- Server: Homebrew (homebrew.mxcl.redis), NOT Docker
- Host: 127.0.0.1:6379
- Password: gggclukaic
- Channels: shell, gg:nlp
- Monitoring: `~/02luka/tools/redis_status.zsh`

## Agent System

**Active Agents:**
- shell_subscriber: Executes commands from Redis shell channel
- gg_nlp_bridge: Maps NLP intents to shell commands
- redis_chain_status: Monitors Redis pub/sub health

**LaunchAgents Requirements:**
- KeepAlive: true (for long-running subscribers)
- ThrottleInterval: 30 (prevent feedback loops)
- RunAtLoad: true (start on boot)

## Whitelist Patterns

**Intent Mapping:** Always check `~/02luka/config/nlp_command_map.yaml` for whitelisted intents.

**Safe Commands:**
- backup.now, sync.expense, restart.health
- deploy.dashboard, restart.filebridge

## File Structure Best Practices

```
~/02luka/
├── 02luka.md                 # Master SOT documentation
├── paths.env                  # Environment variables
├── tools/                     # Executable utilities
├── agents/                    # Agent implementations
├── config/                    # Configuration files
├── logs/                      # All system logs
└── g/                         # Main working directory
    ├── reports/               # Generated reports
    │   ├── sessions/          # Session documentation
    │   └── redis_chain/       # Redis monitoring
    ├── roadmaps/              # Development roadmaps
    └── knowledge/             # MLS lessons
```

## MLS (Memory & Learning System)

Capture lessons with:
```bash
~/02luka/tools/mls_capture.zsh <type> "<title>" "<problem>" "<solution>"
```

Types: solution, failure, pattern, improvement

## Work Order (WO) Creation Decision Pattern

**CRITICAL RULE:** Before fixing issues directly, evaluate using this pattern:

**Decision Rule:**
- **0-1 critical issues** → Fix DIRECTLY (immediate action)
- **2+ issues** → Create WO (deferred to agents)

**Rationale:**
- Single critical issue: Immediate action needed, no delegation overhead
- Multiple issues: Can be batched and handled by agents via WO system

**Examples:**
- 1 critical bug (server crash) → Fix directly ✅
- 3 security issues (hard-coded password, URLs, missing endpoint) → Create WO ✅
- 1 typo → Fix directly ✅
- 5 code quality issues → Create WO ✅

**Enforcement:**
1. **Before direct fix:** Count issues. If count >= 2, create WO instead.
2. **After promising WO:** Create WO file immediately, verify it exists, log to MLS.
3. **MLS verification:** Check MLS for WO promises before direct fixes.

**WO Creation:**
- Use `/do` command or create YAML in `bridge/inbox/ENTRY/`
- Schema: See `.cursor/commands/do.md`
- Verify file exists after creation
- Log to MLS: `mls_capture "followup" "WO Created" "Created WO: <file>"`

**Common Mistake:**
- ❌ Promising to create WO but fixing directly instead
- ❌ Fixing 2+ issues directly (should create WO)
- ✅ Always verify WO file exists after promising creation

## Testing & Verification

Before claiming success:
1. Run the actual command/script
2. Verify output/logs
3. Check system health: `~/02luka/tools/system_health_check.zsh`
4. Test Redis: `~/02luka/tools/redis_status.zsh`

## Development Workflow Protocol

**⚠️⚠️⚠️ FUNDAMENTAL WORKING METHOD - NOT OPTIONAL ⚠️⚠️⚠️**

**THIS IS HOW YOU WORK. EVERY TIME. NO EXCEPTIONS.**

This is the BASIC, DEFAULT way to work. All code changes and system modifications MUST follow this workflow.

**Why:** Safety, accuracy, reliability. Prevents overclaiming without verification.

**Before ANY action, complete:** `g/docs/WORKFLOW_PRE_ACTION_CHECKLIST.md`

**Full Protocol:** `g/docs/WORKFLOW_PROTOCOL_v1.md`  
**Enforcement Strategy:** `g/docs/WORKFLOW_ENFORCEMENT.md`

**Quick Reference:**

**Phase 1: Planning & Specification**
1. **Make Plan** - Break down task into clear steps
2. **Make Spec** - Define requirements and acceptance criteria
3. **Define Goal** - State clear, measurable objective

**Phase 2: Dry-Run & Verification**
4. **Dry-Run** - Execute in non-destructive mode (`-n`, `--dry-run`, simulation)
5. **Verify** - Check output matches expected results

**Phase 3: Decision Branch**

**If Dry-Run Passes:**
6. **Run** - Execute actual changes
7. **Post-Verification** - Confirm changes applied correctly

**If Dry-Run Fails:**
6. **Debug** - Analyze failure points
7. **Optimize** - Fix issues and improve
8. **Re-Verify** - Test again
9. **Repeat** - Minimum 3 optimization cycles before declaring failure
10. **Report** - If still failing after 3+ cycles, document all attempts

**Key Rules (FUNDAMENTAL):**
- ❌ **NEVER** run changes directly without dry-run
- ❌ **NEVER** claim success without verification
- ❌ **NEVER** skip dry-run "to save time"
- ✅ **ALWAYS** dry-run first, verify, then execute
- ✅ **ALWAYS** have evidence/logs before claiming success
- ✅ **MINIMUM** 3 optimization cycles before reporting failure
- ✅ **DOCUMENT** all attempts and findings

**The Safety Rule:**
> "If I haven't dry-run and verified it, I don't know if it works. Therefore, I cannot claim it works."

**The Overclaim Prevention:**
> "Verification is proof. Without proof, there is no claim."

**Examples:**
- Script changes: Test with `set -n` or in test directory first
- Git operations: Use `-n` flag (`git rm --cached -n`) to preview
- File operations: Test with sample data or backup copies

## Workspace Split (Repo/Workspace Separation)

**CRITICAL:** Workspace runtime data is stored outside repo to prevent git operations from destroying data.

**Structure:**
- Repo: `~/02luka` (code-only, safe for git reset/clean)
- Workspace: `~/02luka_ws/` (runtime data: g/data, g/telemetry, mls/ledger, etc.)
- Local: `~/02luka_local/` (machine-specific configs)

**Workspace paths are symlinks:**
- `g/data/` → `~/02luka_ws/g/data`
- `g/telemetry/` → `~/02luka_ws/g/telemetry`
- `g/followup/` → `~/02luka_ws/g/followup`
- `mls/ledger/` → `~/02luka_ws/mls/ledger`
- `bridge/processed/` → `~/02luka_ws/bridge/processed`

**Git Clean Safety:**
- ❌ **NEVER use:** `git clean -fd` (destroys untracked files in repo)
- ✅ **ALWAYS use:** `zsh ~/02luka/tools/safe_git_clean.zsh -n` (dry-run first)
- ✅ **Then:** `zsh ~/02luka/tools/safe_git_clean.zsh -f` (removes only ignored files)

**Guard System:**
- Pre-commit hook automatically runs `guard_workspace_inside_repo.zsh`
- Fails if workspace paths exist as real directories (must be symlinks)
- Prevents accidental workspace data in repo

**Bootstrap:**
- Run `~/02luka/tools/bootstrap_workspace.zsh` to setup symlinks
- Migrates existing data automatically to workspace

## Common Pitfalls

❌ **Don't:**
- Use old paths (`/Users/icmini/LocalProjects/02luka_local_g`)
- Assume Docker for Redis (it's Homebrew!)
- Skip ThrottleInterval in LaunchAgents
- Use KeepAlive: false for subscribers
- Use `git clean -fd` (use safe_git_clean.zsh instead)
- Create workspace directories as real dirs in repo (must be symlinks)

✅ **Do:**
- Use new SOT paths (`/Users/icmini/02luka`)
- Test before claiming success
- Capture MLS lessons
- Document in session reports
- Use `safe_git_clean.zsh` for cleaning (protects workspace data)
- Verify workspace paths are symlinks before committing
