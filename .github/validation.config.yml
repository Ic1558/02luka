---
name: CI (Core)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CI_STRICT: ${{ vars.CI_STRICT || '0' }}

jobs:
  path-guard:
    name: Path Guard [REQUIRED]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Forbid hardcoded wrong paths
        run: |
          set -euo pipefail
          if git grep -nE "/Users/icmini/LocalProjects/02luka(?!-memory)" -- ':!**/.gitignore' ':!**/*.png' ':!**/*.jpg' ; then
            echo "❌ Found forbidden hardcoded path /Users/icmini/LocalProjects/02luka"
            exit 1
          fi
          echo "✅ Path guard passed"

  schema-validate:
    name: Schema Validation [REQUIRED]
    needs: path-guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install ajv-cli & ajv-formats
        run: |
          npm i -g ajv-cli@5 ajv-formats@3
      - name: Validate RAG pipeline schema
        run: |
          if [ -f config/schemas/rag_pipeline.schema.json ] && [ -f config/rag_pipeline.yaml ]; then
            ajv validate -s config/schemas/rag_pipeline.schema.json -d config/rag_pipeline.yaml --strict=true
          else
            echo "No RAG pipeline schema/yaml; skipping"
          fi
      - name: Validate Kim proxy gateway schema
        run: |
          if [ -f config/schemas/kim_proxy_gateway.schema.json ] && [ -f config/kim_proxy_gateway.yaml ]; then
            ajv validate -s config/schemas/kim_proxy_gateway.schema.json -d config/kim_proxy_gateway.yaml --strict=true
          else
            echo "No Kim proxy schema/yaml; skipping"
          fi

  validate:
    name: Phase 4/5/6 smoke (local) [REQUIRED]
    needs: [path-guard, schema-validate]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Core validation
        run: |
          set -euo pipefail
          if [ -x tools/ci/validate.sh ]; then
            bash tools/ci/validate.sh
          else
            echo "No tools/ci/validate.sh; passing"
          fi

  ops-gate:
    name: Phase 5/6/7 smoke (ops) [OPTIONAL]
    needs: validate
    runs-on: macos-latest
    if: env.CI_STRICT == '1'
    continue-on-error: true
    env:
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD || '' }}
    steps:
      - uses: actions/checkout@v4
      - name: Ops gate
        run: |
          set -euo pipefail
          if [ -x ./scripts/ops_gate.sh ]; then
            ./scripts/ops_gate.sh || true
          else
            echo "No ops_gate.sh; skipping"
          fi

  rag-vector-selftest:
    name: Phase 15 RAG Vector Search [OPTIONAL]
    needs: validate
    runs-on: ubuntu-latest
    if: env.CI_STRICT == '1'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: RAG self-test
        run: |
          set -euo pipefail
          if [ -x ./scripts/rag_selftest.sh ]; then
            ./scripts/rag_selftest.sh || true
          else
            echo "No rag_selftest.sh; skipping"
          fi
---
name: CLS CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CI_STRICT: ${{ vars.CI_STRICT || '0' }}

jobs:
  sanity:
    name: Sanity Gate
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "CI_STRICT=${CI_STRICT}"
          if [ "${CI_STRICT}" != "1" ]; then
            echo "Skipping heavy CLS checks (set repo variable CI_STRICT=1 to enable)."
          fi

  cls-checks:
    name: CLS integration checks [OPTIONAL]
    needs: sanity
    runs-on: ubuntu-latest
    if: env.CI_STRICT == '1'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Smoke
        run: |
          set -euo pipefail
          if [ -x tools/cls_smoke.zsh ]; then
            zsh tools/cls_smoke.zsh || true
          else
            echo "No CLS smoke script; skipping"
          fi
---
name: Router Selftest

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CI_STRICT: ${{ vars.CI_STRICT || '0' }}

jobs:
  router-selftest:
    name: Router Core Selftest [OPTIONAL]
    runs-on: ubuntu-latest
    if: env.CI_STRICT == '1'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Run router self-tests
        run: |
          set -euo pipefail
          if [ -x scripts/router_selftest.sh ]; then
            bash scripts/router_selftest.sh || true
          else
            echo "No router_selftest.sh; skipping"
          fi
