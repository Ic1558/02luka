name: Auto-Index Memory Repository

on:
  push:
    branches: [main]
    paths:
      - 'hub/**'
      - '.github/workflows/auto-index.yml'
  workflow_dispatch:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  repository_dispatch:
    types: [memory-repo-updated]

permissions:
  contents: write

concurrency:
  group: auto-index-${{ github.ref }}
  cancel-in-progress: true

jobs:
  auto-index:
    if: ${{ !(github.event_name == 'push' && github.actor == 'github-actions[bot]') }}
    name: Auto-Index Memory Repo
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: code-repo

      - name: 'Preflight: check MEM_REPO_TOKEN'
        run: |
          TOKEN="${{ secrets.MEM_REPO_TOKEN }}"
          if [ -z "$TOKEN" ]; then
            echo '::error title=Missing secret::MEM_REPO_TOKEN is not configured in repo secrets'
            echo 'Go to Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret'
            echo 'Name: MEM_REPO_TOKEN (fine‚Äëgrained PAT with Contents: Read/Write on Ic1558/02luka-memory)'
            exit 1
          else
            echo '‚úÖ MEM_REPO_TOKEN present (value is masked)'
          fi

      - name: Checkout memory repository
        uses: actions/checkout@v4
        with:
          repository: Ic1558/02luka-memory
          path: memory-repo
          token: ${{ secrets.MEM_REPO_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: code-repo/hub
        run: |
          if [ -f package.json ]; then
            npm ci --no-audit --no-fund
          else
            echo "No package.json found, skipping npm install"
          fi

      - name: Run auto-indexer
        working-directory: code-repo
        env:
          LUKA_MEM_REPO_ROOT: ${{ github.workspace }}/memory-repo
          HUB_INDEX_PATH: ${{ github.workspace }}/code-repo/hub/index.json
        run: |
          export REDIS_URL="${REDIS_URL:-redis://localhost:6379}"
          node hub/hub_autoindex.mjs

      - name: Generate MCP registry
        working-directory: code-repo
        run: |
          node hub/mcp_discovery.mjs
          test -f hub/mcp_registry.json || { echo "‚ùå mcp_registry.json not generated"; exit 1; }
          echo "‚úÖ MCP registry generated"

      - name: Assert MCP registry
        working-directory: code-repo
        run: |
          jq -e '._meta.source=="mcp_discovery.mjs"' hub/mcp_registry.json >/dev/null || { echo "‚ùå Invalid source"; exit 1; }
          jq -e '.servers | length >= 0' hub/mcp_registry.json >/dev/null || { echo "‚ùå Invalid servers array"; exit 1; }
          echo "‚úÖ MCP registry structure valid"
          # Note: local_02luka might not exist in CI (uses HOME fallback)
          CFG=$(jq -r '._meta.config_path // empty' hub/mcp_registry.json)
          if [ -n "$CFG" ] && [ ! -f "$CFG" ]; then
            echo "‚ö†Ô∏è  Warning: _meta.config_path points to a non-existent file in CI: $CFG"
          fi

      - name: Commit and push index.json
        working-directory: code-repo
        run: |
          git config user.name "02LUKA Bot"
          git config user.email "bot@02luka.local"
          
          # Stage without modifying index to detect changes against HEAD
          git add -N hub/index.json hub/mcp_registry.json 2>/dev/null || true
          if git status --porcelain hub/index.json hub/mcp_registry.json | grep -q .; then
            git add hub/index.json hub/mcp_registry.json
            git commit -m "chore(hub): Auto-update index & MCP registry [skip ci]" -m "ü§ñ Automated update via GitHub Actions" -m "Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>" || true

            # Retry push with pull-rebase on race condition
            # Note: Protected branch may require status checks; push failures are non-fatal for auto-updates
            for i in 1 2 3; do
              if git push origin main; then
                echo "‚úÖ Push succeeded on attempt $i"
                break
              else
                PUSH_ERROR=$(git push origin main 2>&1 || true)
                if echo "$PUSH_ERROR" | grep -q "protected branch\|Required status check"; then
                  echo "‚ö†Ô∏è  Push blocked by branch protection (status checks required)"
                  echo "‚ÑπÔ∏è  This is expected for protected branches; commit is created locally"
                  break
                else
                  echo "‚ö†Ô∏è  Push failed on attempt $i, pulling latest changes..."
                  git pull --rebase origin main || { echo "‚ùå Rebase failed"; exit 1; }
                  [ $i -lt 3 ] && sleep 2
                fi
              fi
            done
          else
            echo "No changes to hub files"
          fi

      - name: Update memory repo symlinks
        working-directory: memory-repo
        run: |
          git config user.name "02LUKA Bot"
          git config user.email "bot@02luka.local"
          
          # Create/update symlinks for latest index
          INDEX_FILE="${{ github.workspace }}/code-repo/hub/index.json"
          if [ -f "$INDEX_FILE" ]; then
            mkdir -p GG/context
            ln -sf "$INDEX_FILE" GG/context/LATEST.index.json || true
            echo "Updated symlink: GG/context/LATEST.index.json"
          fi
          
          # Commit if there are changes
          if ! git diff --quiet; then
            git add -A
            git commit -m "chore: Update index symlinks" -m "ü§ñ Automated symlink update via GitHub Actions" -m "Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>" || true
            git push origin main || true
          fi
