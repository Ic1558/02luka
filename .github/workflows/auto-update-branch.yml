name: auto-update-branch
on:
  push:
    branches: [ main ]          # เมื่อ main อัปเดต ให้ลองอัปเดตทุก PR ที่เปิดอยู่
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write               # ให้ GITHUB_TOKEN push โค้ดกลับได้
  pull-requests: write

jobs:
  update:
    if: ${{ github.event_name == 'pull_request' || github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Get PRs (when main pushed)
        if: ${{ github.event_name == 'push' }}
        uses: actions/github-script@v7
        id: prs
        with:
          script: |
            const { data } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            return data
              .filter(pr => pr.head.repo.full_name === context.repo.owner + '/' + context.repo.repo)
              .map(pr => pr.head.ref)
              .join(',');

      - name: Update each PR branch (from main push)
        if: ${{ github.event_name == 'push' }}
        uses: actions/github-script@v7
        with:
          script: |
            const refs = '${{ steps.prs.outputs.result }}';
            if (!refs) {
              core.info('No PRs to update');
              return;
            }
            for (const ref of refs.split(',')) {
              core.info(`::group::Updating ${ref}`);
              await exec.exec('bash', ['-lc', `
                git init -q
                git remote add origin https://github.com/${process.env.GITHUB_REPOSITORY}.git
                git fetch origin ${ref} main --depth=1
                git checkout -q -B ${ref} origin/${ref}
                git merge --no-edit origin/main || git rebase origin/main
                git push --force-with-lease origin ${ref}
              `]);
              core.info('::endgroup::');
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # เมื่อ event คือ pull_request ให้รีเบสเฉพาะ branch ของ PR นั้นๆ
      - name: Checkout PR branch
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebase/merge main into PR
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          git fetch origin main --depth=1
          
          # Check if already up to date (no commits in main that aren't in HEAD)
          if git merge-base --is-ancestor HEAD origin/main && [ "$(git rev-parse HEAD)" = "$(git rev-parse origin/main)" ]; then
            echo "Branch is already up to date with main"
            exit 0
          fi
          
          # Check if main is already merged into HEAD
          if git merge-base --is-ancestor origin/main HEAD; then
            echo "Main is already merged into branch"
            exit 0
          fi
          
          # Try rebase first, but abort on conflicts and fallback to merge
          if git rebase origin/main; then
            echo "Rebase successful"
          else
            echo "Rebase failed, aborting and trying merge instead"
            git rebase --abort 2>/dev/null || true
            if git merge --no-edit origin/main; then
              echo "Merge successful"
            else
              echo "Both rebase and merge failed - merge conflicts require manual resolution"
              echo "This is expected when branches have diverged significantly"
              exit 0  # Exit successfully - conflicts will be resolved manually
            fi
          fi
          
          # Push only if there are changes
          if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/${{ github.event.pull_request.head.ref }})" ]; then
            git push --force-with-lease origin HEAD:${{ github.event.pull_request.head.ref }}
          else
            echo "No changes to push"
          fi
