name: CLS CI
run-name: "CLS CI (${{ github.event_name }}): strict=${{ github.event.inputs.ci_strict || vars.CI_STRICT || '0' }}"

on:
  pull_request:
  schedule:
    - cron: '0 17 * * *'  # 00:00 Asia/Bangkok (UTC+7)
  workflow_dispatch:
    inputs:
      ci_strict:
        description: 'Strict mode (0/1)'
        required: false
        default: '0'
        type: string

permissions:
  contents: write

concurrency:
  group: "cls-ci"
  cancel-in-progress: true

jobs:
  sanity:
    outputs:
      ci_strict: ${{ steps.setflag.outputs.ci_strict }}
    name: Sanity Gate
    runs-on: ubuntu-latest
    steps:
      - name: Determine OS flag
        shell: bash
        run: |
          # Running on ubuntu-latest, so IS_MAC=0
          echo "IS_MAC=0" >> "$GITHUB_ENV"
      - name: Load CI_STRICT
        id: setflag
        shell: bash
        run: |
          VAL="${{ github.event.inputs.ci_strict }}"
          if [ "${{ github.event_name }}" = "schedule" ]; then
            VAL=1
          elif [ -z "$VAL" ]; then
            VAL="${{ vars.CI_STRICT }}"
          fi
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
          echo "ci_strict=$VAL" >> "$GITHUB_OUTPUT"
      - run: |
          echo "CI_STRICT=$CI_STRICT  IS_MAC=$IS_MAC"
          echo "::notice ::Soft-green gate. Set repo variable CI_STRICT=1 to enable heavy jobs."
          if [ "${CI_STRICT}" != "1" ]; then
            echo "Soft-green: skipping heavy jobs (set CI_STRICT=1 to enable)"
            exit 0
          fi

  selfcheck:
    name: Self-Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: sanity

    steps:
      - name: Show workflow version
        run: |
          echo "WF_SHA=${{ github.sha }}"
          echo "WF_REF=${{ github.ref }}"

      - name: Determine OS flag
        shell: bash
        run: |
          # Running on ubuntu-latest, so IS_MAC=0
          echo "IS_MAC=0" >> "$GITHUB_ENV"
      - name: Load CI_STRICT & Redis URL
        shell: bash
        run: |
          # Prefer shell fallback over GitHub expression to avoid editor schema false-positives
          VAL="${{ vars.CI_STRICT }}"
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
          
          REDIS_VAL="${{ secrets.LUKA_REDIS_URL }}"
          if [ -z "$REDIS_VAL" ]; then REDIS_VAL=""; fi
          echo "LUKA_REDIS_URL=$REDIS_VAL" >> "$GITHUB_ENV"
      - name: Checkout repository
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install dependencies
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq zsh

      - name: Create output directories
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          mkdir -p hub
          mkdir -p g/state/alerts
          mkdir -p g/logs

      - name: Run Bridge Self-Check
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          echo "üîç Starting bridge self-check..."
          zsh tools/bridge_selfcheck.zsh
        env:
          BRIDGE_STUCK_THRESHOLD_HOURS: ${{ github.event.inputs.stuck_threshold_hours || '24' }}
          LUKA_HOME: ${{ github.workspace }}

      - name: Verify Self-Check Output
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          echo "üìä Bridge Self-Check Results"
          echo "=============================="

          if [[ -f hub/bridge_selfcheck.json ]]; then
            echo ""
            echo "‚úÖ Self-check report generated"
            echo ""
            echo "üìÑ Report Summary:"
            jq -r '.summary | "  Total Agents: \(.total_agents)\n  Healthy: \(.healthy_count)\n  Warnings: \(.warning_count)\n  Critical: \(.critical_count)\n  Total Issues: \(.total_issues)"' hub/bridge_selfcheck.json

            echo ""
            echo "üîç Agent Details:"
            jq -r '.agents[] | "  \(.agent_id): \(.status) (\(.metrics.pending_work_orders) pending, \(.metrics.stuck_files) stuck)"' hub/bridge_selfcheck.json

            # Show issues if any
            issue_count=$(jq '[.agents[].issues[]] | length' hub/bridge_selfcheck.json)
            if [[ $issue_count -gt 0 ]]; then
              echo ""
              echo "‚ö†Ô∏è  Issues Detected:"
              jq -r '.agents[] | select(.issues | length > 0) | "  [\(.agent_id)] \(.issues[] | "\(.severity | ascii_upcase): \(.message)")"' hub/bridge_selfcheck.json
            fi
          else
            echo "‚ùå Self-check report not found!"
            exit 1
          fi

      - name: Stage report for artifacts
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          mkdir -p output/reports
          cp hub/bridge_selfcheck.json output/reports/selfcheck.json

      - name: Setup Node.js
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install ajv-cli (pinned)
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          npm install -g ajv-cli@5 ajv-formats@3

      - name: Validate against schema
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          echo "üìã Validating report against JSON schema..."
          ajv validate \
            -s config/schemas/bridge_selfcheck.schema.json \
            -d hub/bridge_selfcheck.json \
            --strict=false
          echo "‚úÖ Report is valid"

      - name: Publish to Redis (if configured)
        if: ${{ needs.sanity.outputs.ci_strict == '1' && env.LUKA_REDIS_URL != '' }}
        run: |
          if command -v redis-cli &> /dev/null; then
            echo "üì¢ Publishing bridge:selfcheck event to Redis..."

            payload=$(jq -c '{
              type: "bridge.selfcheck.completed",
              timestamp: .timestamp,
              status: .status,
              summary: .summary
            }' hub/bridge_selfcheck.json)

            redis-cli -u "${LUKA_REDIS_URL}" PUBLISH "bridge:selfcheck" "$payload" || echo "Redis publish failed (non-critical)"
          else
            echo "‚ÑπÔ∏è  Redis CLI not available, skipping event publish"
          fi

      - name: Auto-commit snapshot
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add the snapshot
          git add hub/bridge_selfcheck.json

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "chore(bridge): auto-update self-check snapshot - $timestamp"

            # Push with retry logic
            attempt=0
            until git push; do
              attempt=$((attempt+1))
              if [ $attempt -ge 3 ]; then
                echo "Failed to push after $attempt attempts"
                exit 1
              fi
              echo "Retry $attempt after brief backoff..."
              sleep 2
              git pull --rebase
            done

            echo "‚úÖ Snapshot committed and pushed"
          fi

      - name: Upload artifact (selfcheck-report)
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: selfcheck-report
          path: |
            output/reports/selfcheck.json
          retention-days: 14
          if-no-files-found: warn

      - name: Upload artifact (bridge-selfcheck-report alias)
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: bridge-selfcheck-report
          path: |
            output/reports/selfcheck.json
          retention-days: 14
          if-no-files-found: warn

      - name: Check for critical issues
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          status=$(jq -r '.status' hub/bridge_selfcheck.json)

          if [[ "$status" == "critical" ]]; then
            echo "‚ùå Critical issues detected in bridge integrity!"
            echo ""
            echo "Critical Issues:"
            jq -r '.agents[] | select(.issues[] | select(.severity == "critical")) | "  [\(.agent_id)] \(.issues[] | select(.severity == "critical") | .message)"' hub/bridge_selfcheck.json
            exit 1
          elif [[ "$status" == "warning" ]]; then
            echo "‚ö†Ô∏è  Warnings detected but not critical"
            exit 0
          else
            echo "‚úÖ All bridge folders are healthy"
            exit 0
          fi
