---
name: ci / ops-gate
on:  # yamllint disable-line rule:truthy
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sanity:
    name: Sanity Gate
    runs-on: ubuntu-latest
    steps:
      - name: Determine OS flag
        shell: bash
        run: |
          # Running on ubuntu-latest, so IS_MAC=0
          echo "IS_MAC=0" >> "$GITHUB_ENV"
      - name: Load CI_STRICT
        shell: bash
        run: |
          # Prefer shell fallback over GitHub expression to avoid editor schema false-positives
          VAL="${{ vars.CI_STRICT }}"
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
      - run: |
          echo "CI_STRICT=$CI_STRICT  IS_MAC=$IS_MAC"
          echo "::notice ::Soft-green gate. Set repo variable CI_STRICT=1 to enable heavy jobs."
          if [ "${CI_STRICT}" != "1" ]; then
            echo "Soft-green: skipping heavy jobs (set CI_STRICT=1 to enable)"
            exit 0
          fi

  ops-gate:
    runs-on: ubuntu-latest
    env:
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD || '' }}
      OPS_ATOMIC_URL: http://127.0.0.1:4000

    services:
      redis:
        image: redis:7-alpine
        ports: ['6379:6379']
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=3s
          --health-timeout=2s
          --health-retries=10

    steps:
      - name: Load CI_STRICT
        shell: bash
        run: |
          # Prefer shell fallback over GitHub expression to avoid editor schema false-positives
          VAL="${{ vars.CI_STRICT }}"
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
      - name: Check CI_STRICT
        if: env.CI_STRICT != '1'
        run: |
          echo "Soft-green: skipping ops-gate (set CI_STRICT=1 to enable)"
          exit 0
      - name: Determine OS flag
        shell: bash
        run: |
          # Running on ubuntu-latest, so IS_MAC=0
          echo "IS_MAC=0" >> "$GITHUB_ENV"
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq redis-tools
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install root npm packages
        run: npm ci || echo "âš ï¸ No root package-lock.json, skipping"

      - name: Install boss-api dependencies
        run: |
          if [ -f boss-api/package.json ]; then
            echo "ðŸ“¦ Installing boss-api dependencies..."
            npm ci --prefix boss-api
          else
            echo "âš ï¸ boss-api/package.json not found, skipping"
          fi

      - name: Check boss-api structure
        run: |
          echo "ðŸ“¦ Checking boss-api structure..."
          if [ -d boss-api ]; then
            echo "âœ… boss-api directory exists"
            ls -la boss-api/ | head -10
          else
            echo "âš ï¸ boss-api directory not found"
          fi
          echo "Note: boss-api server not started - smoke tests will skip API checks in CI"

      - name: Verify Redis connection
        run: |
          echo "ðŸ” Testing Redis connection..."
          # Build redis-cli arguments conditionally
          REDIS_ARGS=()
          if [[ -n "$REDIS_PASSWORD" ]]; then
            REDIS_ARGS+=("-a" "$REDIS_PASSWORD")
          fi

          # Test with 'redis' hostname (service name)
          redis-cli -h redis -p 6379 "${REDIS_ARGS[@]}" ping || echo "âš ï¸ Redis not accessible via 'redis' hostname"

          # Test with localhost
          redis-cli -h 127.0.0.1 -p 6379 "${REDIS_ARGS[@]}" ping || echo "âš ï¸ Redis not accessible via localhost"

      - name: Opt out boss-api in CI
        run: echo "SKIP_BOSS_API=1" >> "$GITHUB_ENV"

      - name: Run ops-gate
        run: tools/ci/ops_gate.sh
