---
name: CLS Web Integration & Load Test

on:
  pull_request:
  workflow_dispatch:
    inputs:
      ci_strict:
        description: 'Strict mode (0/1)'
        required: false
        default: '0'
        type: string

permissions:
  contents: read

concurrency:
  group: cls-ci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sanity:
    name: Sanity Gate
    runs-on: ubuntu-latest
    outputs:
      ci_strict: ${{ steps.setflag.outputs.ci_strict }}
    steps:
      - name: Load CI_STRICT
        id: setflag
        shell: bash
        run: |
          VAL="${{ github.event.inputs.ci_strict }}"
          if [ -z "$VAL" ]; then VAL="${{ vars.CI_STRICT }}"; fi
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
          echo "ci_strict=$VAL" >> "$GITHUB_OUTPUT"
      - name: Echo gate
        run: |
          echo "CI_STRICT=$CI_STRICT"
          if [ "$CI_STRICT" != "1" ]; then
            echo "Soft-green: heavy jobs will be skipped."
          fi

  cls-web-load-test:
    name: CLS Web Load Test [heavy]
    needs: sanity
    if: ${{ needs.sanity.outputs.ci_strict == '1' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo "heavy jobs go here"

  summary:
    name: CLS Web Test Summary
    needs: [sanity, cls-web-load-test]
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "Sanity gate: ${{ needs.sanity.outputs.ci_strict }}"
          if [ "${{ needs.sanity.outputs.ci_strict }}" != "1" ]; then
            echo "Summary: Heavy tests were intentionally skipped (soft-green)."
          else
            echo "Summary: Heavy tests ran."
