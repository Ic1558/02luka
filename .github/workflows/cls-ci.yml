name: CLS Web Integration & Load Test

on:
  pull_request:
  workflow_dispatch:
    inputs:
      ci_strict:
        description: 'Strict mode (0/1)'
        required: false
        default: '0'
        type: string

permissions:
  contents: read

concurrency:
  group: cls-ci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sanity:
    name: Sanity Gate
    runs-on: ubuntu-latest
    outputs:
      ci_strict: ${{ steps.setflag.outputs.ci_strict }}
    steps:
      - name: Load CI_STRICT
        id: setflag
        shell: bash
        run: |
          VAL="${{ github.event.inputs.ci_strict }}"
          if [ -z "$VAL" ]; then VAL="${{ vars.CI_STRICT }}"; fi
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
          echo "ci_strict=$VAL" >> "$GITHUB_OUTPUT"
      - name: Echo gate
        run: |
          echo "CI_STRICT=$CI_STRICT"
          if [ "$CI_STRICT" != "1" ]; then
            echo "::notice::Soft-green: heavy jobs will be skipped. Set repo variable CI_STRICT=1 to enable."
          fi

  # Heavy tests – run ONLY when ci_strict == '1'
  cls-web-load-test:
    name: CLS Web Load Test [heavy]
    needs: sanity
    if: ${{ needs.sanity.outputs.ci_strict == '1' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run heavy load test
        run: |
          echo "Heavy CLS Web load test running..."
          # Add actual test commands here when services are ready

  summary:
    name: CLS Web Test Summary
    needs: [sanity, cls-web-load-test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary Report
        run: |
          echo "### CLS Web CI Summary"
          echo ""
          echo "Sanity gate: ci_strict=${{ needs.sanity.outputs.ci_strict }}"
          if [ "${{ needs.sanity.outputs.ci_strict }}" != "1" ]; then
            echo "✅ Summary: Heavy tests were intentionally skipped (soft-green mode)."
          else
            echo "✅ Summary: Heavy tests ran."
          fi
