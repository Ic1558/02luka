---
name: CLS CI
run-name: "CLS CI (${{ github.event_name }}): strict=${{ github.event.inputs.ci_strict || vars.CI_STRICT || '0' }}"

on:
  pull_request:
  schedule:
    - cron: '0 17 * * *'  # 00:00 Asia/Bangkok (UTC+7)
  workflow_dispatch:
    inputs:
      ci_strict:
        description: 'Strict mode (0/1)'
        required: false
        default: '0'
        type: string

permissions:
  contents: write

concurrency:
  group: bridge-selfcheck-ci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sanity:
    name: Sanity Gate
    runs-on: ubuntu-latest
    outputs:
      ci_strict: ${{ steps.setflag.outputs.ci_strict }}
    steps:
      - name: Load CI_STRICT
        id: setflag
        shell: bash
        run: |
          VAL="${{ github.event.inputs.ci_strict }}"
          if [ "${{ github.event_name }}" = "schedule" ]; then
            VAL=1
          elif [ -z "$VAL" ]; then
            VAL="${{ vars.CI_STRICT }}"
          fi
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
          echo "ci_strict=$VAL" >> "$GITHUB_OUTPUT"
      - name: Echo gate
        run: |
          echo "CI_STRICT=$CI_STRICT"
          if [ "$CI_STRICT" != "1" ]; then
            echo "Soft-green: heavy jobs will be skipped."
          fi

  selfcheck:
    name: Self-Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: sanity
    steps:
      - name: Show workflow version
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          echo "WF_SHA=${{ github.sha }}"
          echo "WF_REF=${{ github.ref }}"

      - name: Checkout repository
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        uses: actions/checkout@v4

      - name: Install dependencies
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq zsh

      - name: Create output directories
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          mkdir -p hub
          mkdir -p g/state/alerts
          mkdir -p g/logs
          mkdir -p output/reports

      - name: Run Bridge Self-Check
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          echo "üîç Starting bridge self-check..."
          zsh tools/bridge_selfcheck.zsh
        env:
          BRIDGE_STUCK_THRESHOLD_HOURS: ${{ github.event.inputs.stuck_threshold_hours || '24' }}
          LUKA_HOME: ${{ github.workspace }}

      - name: Verify Self-Check Output
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          echo "üìä Bridge Self-Check Results"
          echo "=============================="
          
          if [[ -f hub/bridge_selfcheck.json ]]; then
            echo ""
            echo "‚úÖ Self-check report generated"
            echo ""
            echo "üìÑ Report Summary:"
            jq -r '.summary | "  Total Agents: \(.total_agents)\n  Healthy: \(.healthy_count)\n  Warnings: \(.warning_count)\n  Critical: \(.critical_count)\n  Total Issues: \(.total_issues)"' hub/bridge_selfcheck.json || echo "‚ö†Ô∏è  Unable to parse summary"
          else
            echo "‚ùå Self-check report not found!"
            exit 1
          fi

      - name: Stage report for artifacts
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          mkdir -p output/reports
          cp hub/bridge_selfcheck.json output/reports/selfcheck.json

      - name: "Guard: ensure staged artifact exists"
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          if [ ! -f output/reports/selfcheck.json ]; then
            echo "‚ùå selfcheck.json missing ‚Äî stage step may have failed"
            ls -la output/reports || true
            exit 1
          fi

      - name: Upload artifact (selfcheck-report)
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: selfcheck-report
          path: |
            output/reports/selfcheck.json
          retention-days: 14
          if-no-files-found: warn

      - name: Decide escalation prompt
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        shell: bash
        run: |
          mkdir -p output/alerts g/state/alerts
          STATUS="$(jq -r '.status' hub/bridge_selfcheck.json 2>/dev/null || echo "unknown")"
          WARN="$(jq -r '.summary.warning_count' hub/bridge_selfcheck.json 2>/dev/null || echo "0")"
          CRIT="$(jq -r '.summary.critical_count' hub/bridge_selfcheck.json 2>/dev/null || echo "0")"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          prompt_file="output/alerts/escalation_prompt.txt"
          : > "$prompt_file"

          if [[ "$STATUS" == "critical" || "$CRIT" != "0" ]]; then
            {
              echo "NEEDS ELEVATION ‚Üí CLC (privileged)"
              echo "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏û‡∏ö critical issues ‡πÉ‡∏ô bridge/self-check"
              echo "‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: ‡πÉ‡∏ä‡πâ CLC ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏ü‡∏•‡πå/‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå/‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ privileged write"
              echo ""
              echo "Run URL: $RUN_URL"
              echo "Status: $STATUS, warnings=$WARN, critical=$CRIT"
            } > "$prompt_file"
          elif [[ "$STATUS" == "warning" || "$WARN" != "0" ]]; then
            {
              echo "ATTENTION ‚Üí Mary/GC"
              echo "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏û‡∏ö warnings ‡πÉ‡∏ô bridge/self-check"
              echo "‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞ escalate ‡πÑ‡∏õ CLC ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"
              echo ""
              echo "Run URL: $RUN_URL"
              echo "Status: $STATUS, warnings=$WARN, critical=$CRIT"
            } > "$prompt_file"
          else
            rm -f "$prompt_file"
          fi

          if [[ -f "output/alerts/escalation_prompt.txt" ]]; then
            cp "output/alerts/escalation_prompt.txt" "g/state/alerts/escalation_prompt.txt" || true
          fi

      - name: Upload escalation prompt (if any)
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        uses: actions/upload-artifact@v4
        with:
          name: escalation-prompt
          path: output/alerts/escalation_prompt.txt
          if-no-files-found: ignore
          retention-days: 7

      - name: Write MLS event (strict success)
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        shell: bash
        run: |
          DAY="$(date +%Y-%m-%d)"
          LEDGER_DIR="mls/ledger"
          mkdir -p "$LEDGER_DIR"
          OUTFILE="$LEDGER_DIR/${DAY}.jsonl"

          RUN_ID="${{ github.run_id }}"
          SHA="${{ github.sha }}"
          REPO="${{ github.repository }}"
          WF="cls-ci.yml"
          ART="selfcheck-report"
          ART_PATH="output/reports/selfcheck.json"

          # Build a single-line JSON object and append to JSONL ledger
          jq -n \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg type "solution" \
            --arg title "CLS strict CI artifact uploaded" \
            --arg summary "selfcheck-report uploaded and validated; bridge healthy" \
            --arg producer "cls" \
            --arg context "ci" \
            --arg repo "$REPO" \
            --arg run_id "$RUN_ID" \
            --arg workflow "$WF" \
            --arg sha "$SHA" \
            --arg artifact "$ART" \
            --arg artifact_path "$ART_PATH" \
            --arg author "gg" \
            --argjson confidence 0.9 \
            '
            {
              ts: $ts,
              type: $type,
              title: $title,
              summary: $summary,
              source: {
                producer: $producer,
                context: $context,
                repo: $repo,
                run_id: $run_id,
                workflow: $workflow,
                sha: $sha,
                artifact: $artifact,
                artifact_path: $artifact_path
              },
              links: { followup_id: null, wo_id: null },
              tags: ["bridge","strict","artifact","healthy"],
              author: $author,
              confidence: $confidence
            }
            ' >> "$OUTFILE"

          echo "üìò MLS appended ‚Üí $OUTFILE"

      - name: Update status summary and commit
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        shell: bash
        run: |
          DAY="$(date +%Y-%m-%d)"
          DATE_STR="$(date +%y%m%d)"
          STATUS_DIR="mls/status"
          mkdir -p "$STATUS_DIR"
          
          RUN_ID="${{ github.run_id }}"
          SHA="${{ github.sha }}"
          REPO="${{ github.repository }}"
          
          # Read artifact summary
          if [ -f "output/reports/selfcheck.json" ]; then
            ARTIFACT_SIZE=$(stat -f%z "output/reports/selfcheck.json" 2>/dev/null || stat -c%s "output/reports/selfcheck.json" 2>/dev/null || echo "0")
            ARTIFACT_STATUS=$(jq -r '.status' "output/reports/selfcheck.json")
            ARTIFACT_SUMMARY=$(jq -c '.summary' "output/reports/selfcheck.json")
          else
            ARTIFACT_SIZE="0"
            ARTIFACT_STATUS="unknown"
            ARTIFACT_SUMMARY='{"total_agents":0,"healthy_count":0,"warning_count":0,"critical_count":0,"total_issues":0}'
          fi
          
          # Generate YAML summary using jq to ensure proper YAML format
          jq -n \
            --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg repo "$REPO" \
            --arg run_id "$RUN_ID" \
            --arg sha "$SHA" \
            --arg conclusion "${{ job.status }}" \
            --arg artifact_name "selfcheck-report" \
            --arg artifact_path "~/02luka/__artifacts__/cls_strict/selfcheck.json" \
            --argjson artifact_size "$ARTIFACT_SIZE" \
            --arg artifact_status "$ARTIFACT_STATUS" \
            --argjson artifact_summary "$ARTIFACT_SUMMARY" \
            '{
              date: $date,
              version: 1,
              scope: "CLS ¬∑ Codex CLI ¬∑ CLC ‚Äî artifact & MLS integration",
              repo: $repo,
              workflows: [
                {
                  name: "cls-ci.yml",
                  status: "stable",
                  guards: ["Guard: ensure staged artifact exists"],
                  artifacts: { primary: "selfcheck-report" },
                  mls: { write_on_strict_success: true, validate_if_schema_present: true }
                }
              ],
              runs: {
                last_strict: {
                  run_id: $run_id,
                  head_sha: $sha,
                  conclusion: $conclusion,
                  artifact: {
                    name: $artifact_name,
                    path_local: $artifact_path,
                    size_bytes: $artifact_size,
                    status: $artifact_status,
                    summary: $artifact_summary
                  }
                }
              }
            }' | yq -P > "$STATUS_DIR/${DATE_STR}_ci_cls_codex_summary.yml" 2>/dev/null || \
          jq -n \
            --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg repo "$REPO" \
            --arg run_id "$RUN_ID" \
            --arg sha "$SHA" \
            --arg conclusion "${{ job.status }}" \
            --arg artifact_name "selfcheck-report" \
            --arg artifact_path "~/02luka/__artifacts__/cls_strict/selfcheck.json" \
            --argjson artifact_size "$ARTIFACT_SIZE" \
            --arg artifact_status "$ARTIFACT_STATUS" \
            --argjson artifact_summary "$ARTIFACT_SUMMARY" \
            '{
              date: $date,
              version: 1,
              scope: "CLS ¬∑ Codex CLI ¬∑ CLC ‚Äî artifact & MLS integration",
              repo: $repo,
              workflows: [
                {
                  name: "cls-ci.yml",
                  status: "stable",
                  guards: ["Guard: ensure staged artifact exists"],
                  artifacts: { primary: "selfcheck-report" },
                  mls: { write_on_strict_success: true, validate_if_schema_present: true }
                }
              ],
              runs: {
                last_strict: {
                  run_id: $run_id,
                  head_sha: $sha,
                  conclusion: $conclusion,
                  artifact: {
                    name: $artifact_name,
                    path_local: $artifact_path,
                    size_bytes: $artifact_size,
                    status: $artifact_status,
                    summary: $artifact_summary
                  }
                }
              }
            }' > "$STATUS_DIR/${DATE_STR}_ci_cls_codex_summary.yml"
          
          # Generate JSON summary
          jq -n \
            --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg repo "$REPO" \
            --arg run_id "$RUN_ID" \
            --arg sha "$SHA" \
            --arg conclusion "${{ job.status }}" \
            --arg artifact_name "selfcheck-report" \
            --arg artifact_path "~/02luka/__artifacts__/cls_strict/selfcheck.json" \
            --argjson artifact_size "$ARTIFACT_SIZE" \
            --arg artifact_status "$ARTIFACT_STATUS" \
            --argjson artifact_summary "$ARTIFACT_SUMMARY" \
            '{
              date: $date,
              version: 1,
              scope: "CLS ¬∑ Codex CLI ¬∑ CLC ‚Äî artifact & MLS integration",
              repo: $repo,
              workflows: [
                {
                  name: "cls-ci.yml",
                  status: "stable",
                  guards: ["Guard: ensure staged artifact exists"],
                  artifacts: { primary: "selfcheck-report" },
                  mls: { write_on_strict_success: true, validate_if_schema_present: true }
                }
              ],
              runs: {
                last_strict: {
                  run_id: $run_id,
                  head_sha: $sha,
                  conclusion: $conclusion,
                  artifact: {
                    name: $artifact_name,
                    path_local: $artifact_path,
                    size_bytes: $artifact_size,
                    status: $artifact_status,
                    summary: $artifact_summary
                  }
                }
              }
            }' > "$STATUS_DIR/${DATE_STR}_ci_cls_codex_summary.json"
          
          echo "üìä Status summary generated ‚Üí $STATUS_DIR/${DATE_STR}_ci_cls_codex_summary.{yml,json}"
          
          # Auto-commit status summary
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$STATUS_DIR/${DATE_STR}_ci_cls_codex_summary.yml" "$STATUS_DIR/${DATE_STR}_ci_cls_codex_summary.json"
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs(mls): update status summary for run $RUN_ID" || echo "Commit failed (non-critical)"
          fi

      - name: Setup Node.js
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install ajv-cli (pinned)
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          npm install -g ajv-cli@5 ajv-formats@3

      - name: Validate MLS event (if schema present)
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        shell: bash
        run: |
          SCHEMA="mls/schema/mls_event.schema.json"
          if [ -f "$SCHEMA" ]; then
            echo "üîé Schema found ‚Üí validating last MLS line"
            DAY="$(date +%Y-%m-%d)"
            LEDGER="mls/ledger/${DAY}.jsonl"
            tail -n 1 "$LEDGER" > /tmp/mls_last.json
            ajv validate -s "$SCHEMA" -d /tmp/mls_last.json --strict=false
            echo "‚úÖ MLS event is valid"
          else
            echo "‚ÑπÔ∏è  MLS schema not present, skipping validation"
          fi

      - name: Validate against schema
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          echo "üìã Validating report against JSON schema..."
          ajv validate \
            -s config/schemas/bridge_selfcheck.schema.json \
            -d hub/bridge_selfcheck.json \
            --strict=false
          echo "‚úÖ Report is valid"

      - name: Auto-commit snapshot
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add hub/bridge_selfcheck.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(bridge): auto-update self-check snapshot" || echo "Commit failed (non-critical)"
          fi

      - name: Check for critical issues
        if: ${{ needs.sanity.outputs.ci_strict == '1' }}
        run: |
          status=$(jq -r '.status' hub/bridge_selfcheck.json)
          
          if [[ "$status" == "critical" ]]; then
            echo "‚ùå Critical issues detected in bridge integrity!"
            echo ""
            echo "Critical Issues:"
            jq -r '.agents[] | select(.issues[] | select(.severity == "critical")) | "  [\(.agent_id)] \(.issues[] | select(.severity == "critical") | .message)"' hub/bridge_selfcheck.json
            exit 1
          elif [[ "$status" == "warning" ]]; then
            echo "‚ö†Ô∏è  Warnings detected but not critical"
            exit 0
          else
            echo "‚úÖ All bridge folders are healthy"
            exit 0
          fi

      - name: Publish to Redis (if configured)
        if: ${{ needs.sanity.outputs.ci_strict == '1' && env.LUKA_REDIS_URL != '' }}
        run: |
          if command -v redis-cli &> /dev/null; then
            echo "üì¢ Publishing bridge:selfcheck event to Redis..."
            
            payload=$(jq -c '{
              type: "bridge.selfcheck.completed",
              timestamp: .timestamp,
              status: .status,
              summary: .summary
            }' hub/bridge_selfcheck.json)
            
            redis-cli -u "${LUKA_REDIS_URL}" PUBLISH "bridge:selfcheck" "$payload" || echo "Redis publish failed (non-critical)"
          else
            echo "‚ÑπÔ∏è  Redis CLI not available, skipping event publish"
          fi
        env:
          LUKA_REDIS_URL: ${{ secrets.LUKA_REDIS_URL }}
