---
# yamllint disable-line rule:truthy
name: CLS Web Integration & Load Test

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  push:
    branches: ['claude/phase-20-cls-web*']
  workflow_dispatch:
    inputs:
      ci_strict:
        description: 'Strict mode (0/1)'
        required: false
        default: '0'
        type: string
      load_level:
        description: 'Load test level'
        required: false
        default: 'heavy'
        type: choice
        options:
          - light
          - medium
          - heavy

permissions:
  contents: read
  pull-requests: read
  actions: write

env:
  NODE_VERSION: '20'
  REDIS_HOST: '127.0.0.1'
  REDIS_PORT: 6379
  REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD || '' }}

jobs:
  sanity:
    name: Sanity Gate
    runs-on: ubuntu-latest
    steps:
      - name: Determine OS flag
        shell: bash
        run: |
          # Running on ubuntu-latest, so IS_MAC=0
          echo "IS_MAC=0" >> "$GITHUB_ENV"
      - name: Load CI_STRICT
        shell: bash
        run: |
          # Prefer shell fallback over GitHub expression to avoid editor schema false-positives
          VAL="${{ vars.CI_STRICT }}"
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
      - run: |
          echo "CI_STRICT=$CI_STRICT  IS_MAC=$IS_MAC"
          echo "::notice ::Soft-green gate. Set repo variable CI_STRICT=1 to enable heavy jobs."
          if [ "${CI_STRICT}" != "1" ]; then
            echo "Soft-green: skipping heavy jobs (set CI_STRICT=1 to enable)"
            exit 0
          fi

  # ============================================================
  # HEAVY LOAD TEST: CLS Web Bridge + CI Coordinator
  # Runs when [run-heavy] is in PR title or 'cls' label is present
  # ============================================================
  cls-web-load-test:
    name: CLS Web Load Test [${{ github.event.inputs.load_level || 'heavy' }}]
    runs-on: ubuntu-latest
    timeout-minutes: 25

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=3s
          --health-timeout=2s
          --health-retries=10

    strategy:
      fail-fast: false
      matrix:
        component: ['bridge', 'coordinator']

    steps:
      - name: Load CI_STRICT
        shell: bash
        run: |
          # Prefer shell fallback over GitHub expression to avoid editor schema false-positives
          VAL="${{ vars.CI_STRICT }}"
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
      - name: Check conditions
        shell: bash
        run: |
          # Check if CI_STRICT is enabled
          if [ "${CI_STRICT}" != "1" ]; then
            echo "Soft-green: skipping cls-web-load-test (set CI_STRICT=1 to enable)"
            exit 0
          fi
          # Check other conditions
          SHOULD_RUN=false
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SHOULD_RUN=true
          elif [[ "${{ github.event.pull_request.title }}" == *"[run-heavy]"* ]]; then
            SHOULD_RUN=true
          elif [[ "${{ github.event.pull_request.labels.*.name }}" == *"cls"* ]]; then
            SHOULD_RUN=true
          elif [[ "${{ github.ref }}" == refs/heads/claude/phase-20-cls-web* ]]; then
            SHOULD_RUN=true
          fi
          if [ "$SHOULD_RUN" = false ]; then
            echo "Conditions not met: skipping cls-web-load-test"
            exit 0
          fi
      - name: Determine OS flag
        shell: bash
        run: |
          # Running on ubuntu-latest, so IS_MAC=0
          echo "IS_MAC=0" >> "$GITHUB_ENV"
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq redis-tools
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Verify installations
          jq --version
          yq --version
          redis-cli --version

      - name: Install Node.js dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "âš ï¸ No package-lock.json found, skipping"
          fi

      - name: Verify Redis connection
        run: |
          echo "ğŸ” Testing Redis connection..."
          REDIS_ARGS=()
          if [[ -n "$REDIS_PASSWORD" ]]; then
            REDIS_ARGS+=("-a" "$REDIS_PASSWORD")
          fi

          redis-cli -h 127.0.0.1 -p 6379 "${REDIS_ARGS[@]}" ping
          echo "âœ… Redis is ready"

      - name: Create reports directory
        run: |
          mkdir -p g/reports/cls_web
          chmod 755 g/reports/cls_web

      - name: Set load test parameters
        id: params
        run: |
          LOAD_LEVEL="${{ github.event.inputs.load_level || 'heavy' }}"

          case "$LOAD_LEVEL" in
            light)
              echo "concurrent=5" >> $GITHUB_OUTPUT
              echo "duration=300" >> $GITHUB_OUTPUT
              echo "events_per_min=10" >> $GITHUB_OUTPUT
              ;;
            medium)
              echo "concurrent=10" >> $GITHUB_OUTPUT
              echo "duration=600" >> $GITHUB_OUTPUT
              echo "events_per_min=25" >> $GITHUB_OUTPUT
              ;;
            heavy)
              echo "concurrent=10" >> $GITHUB_OUTPUT
              echo "duration=900" >> $GITHUB_OUTPUT
              echo "events_per_min=50" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "load_level=$LOAD_LEVEL" >> $GITHUB_OUTPUT

      - name: Run CLS Web Bridge (background)
        if: matrix.component == 'bridge'
        run: |
          echo "ğŸš€ Starting CLS Web Bridge..."
          export CLS_MAX_CONCURRENT=${{ steps.params.outputs.concurrent }}
          export CLS_LOG_LEVEL=info
          export CLS_REPORT_DIR=g/reports/cls_web

          node tools/cls_web_bridge.cjs > logs/cls_web_bridge.log 2>&1 &
          BRIDGE_PID=$!
          echo $BRIDGE_PID > /tmp/bridge.pid

          # Wait for bridge to initialize
          sleep 5

          if ps -p $BRIDGE_PID > /dev/null; then
            echo "âœ… CLS Web Bridge started (PID: $BRIDGE_PID)"
          else
            echo "âŒ CLS Web Bridge failed to start"
            cat logs/cls_web_bridge.log
            exit 1
          fi

      - name: Run CI Coordinator (background)
        if: matrix.component == 'coordinator'
        run: |
          echo "ğŸš€ Starting CI Coordinator..."
          export CI_MAX_RETRIES=3
          export CI_LOG_LEVEL=info
          export CI_REPORT_DIR=g/reports/cls_web

          node tools/ci_coordinator.cjs > logs/ci_coordinator.log 2>&1 &
          COORD_PID=$!
          echo $COORD_PID > /tmp/coordinator.pid

          # Wait for coordinator to initialize
          sleep 5

          if ps -p $COORD_PID > /dev/null; then
            echo "âœ… CI Coordinator started (PID: $COORD_PID)"
          else
            echo "âŒ CI Coordinator failed to start"
            cat logs/ci_coordinator.log
            exit 1
          fi

      - name: Generate test load
        run: |
          echo "ğŸ“Š Generating test load..."
          echo "  Level: ${{ steps.params.outputs.load_level }}"
          echo "  Concurrent sessions: ${{ steps.params.outputs.concurrent }}"
          echo "  Duration: ${{ steps.params.outputs.duration }}s"
          echo "  Events per minute: ${{ steps.params.outputs.events_per_min }}"

          # Run load test script
          bash tools/ci/cls_web_gate.sh \
            --concurrent ${{ steps.params.outputs.concurrent }} \
            --duration ${{ steps.params.outputs.duration }} \
            --events-per-min ${{ steps.params.outputs.events_per_min }}

      - name: Wait for processing to complete
        run: |
          echo "â³ Waiting for event processing to complete..."
          sleep 30

          # Check Redis queue depths
          REDIS_ARGS=()
          if [[ -n "$REDIS_PASSWORD" ]]; then
            REDIS_ARGS+=("-a" "$REDIS_PASSWORD")
          fi

          echo "Queue depths:"
          redis-cli "${REDIS_ARGS[@]}" llen ci:queue:high || echo "high: 0"
          redis-cli "${REDIS_ARGS[@]}" llen ci:queue:normal || echo "normal: 0"
          redis-cli "${REDIS_ARGS[@]}" llen ci:queue:low || echo "low: 0"
          redis-cli "${REDIS_ARGS[@]}" llen ci:queue:dlq || echo "dlq: 0"

      - name: Collect metrics
        if: always()
        run: |
          echo "ğŸ“ˆ Collecting final metrics..."

          # Get latest health reports
          if [ -f g/reports/cls_web/phase20_health_latest.json ]; then
            echo "=== CLS Web Bridge Health ==="
            cat g/reports/cls_web/phase20_health_latest.json | jq
          fi

          if [ -f g/reports/cls_web/coordinator_health_latest.json ]; then
            echo "=== CI Coordinator Health ==="
            cat g/reports/cls_web/coordinator_health_latest.json | jq
          fi

          # Count session reports
          SESSION_COUNT=$(find g/reports/cls_web -name "session_*.json" | wc -l)
          echo "Total sessions: $SESSION_COUNT"

          # Count DLQ events
          DLQ_COUNT=$(find g/reports/cls_web -name "dlq_*.json" | wc -l)
          echo "Dead letter queue events: $DLQ_COUNT"

      - name: Generate summary report
        if: always()
        run: |
          cat > g/reports/cls_web/load_test_summary.md <<'EOF'
          # Phase 20 CLS Web Load Test Summary

          ## Test Configuration
          - **Component**: ${{ matrix.component }}
          - **Load Level**: ${{ steps.params.outputs.load_level }}
          - **Concurrent Sessions**: ${{ steps.params.outputs.concurrent }}
          - **Duration**: ${{ steps.params.outputs.duration }}s
          - **Events per Minute**: ${{ steps.params.outputs.events_per_min }}
          - **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Results

          EOF

          # Add metrics
          if [ -f g/reports/cls_web/phase20_health_latest.json ]; then
            echo "### CLS Web Bridge Metrics" >> g/reports/cls_web/load_test_summary.md
            cat g/reports/cls_web/phase20_health_latest.json | \
              jq -r '"- Active Sessions: \(.activeSessions)\n- Total Sessions: \(.metrics.totalSessions)\n- Completed: \(.metrics.completedSessions)\n- Failed: \(.metrics.failedSessions)\n- Events Processed: \(.metrics.eventsProcessed)\n- Errors: \(.metrics.errors)"' \
              >> g/reports/cls_web/load_test_summary.md
          fi

          if [ -f g/reports/cls_web/coordinator_health_latest.json ]; then
            echo -e "\n### CI Coordinator Metrics" >> g/reports/cls_web/load_test_summary.md
            cat g/reports/cls_web/coordinator_health_latest.json | \
              jq -r '.metrics | "- Total Events: \(.totalEvents)\n- Processed: \(.processedEvents)\n- Failed: \(.failedEvents)\n- Retried: \(.retriedEvents)\n- Dead Letter: \(.deadLetterEvents)"' \
              >> g/reports/cls_web/load_test_summary.md
          fi

          echo -e "\n## Queue Depths" >> g/reports/cls_web/load_test_summary.md
          echo "- High: $(redis-cli llen ci:queue:high 2>/dev/null || echo 0)" >> g/reports/cls_web/load_test_summary.md
          echo "- Normal: $(redis-cli llen ci:queue:normal 2>/dev/null || echo 0)" >> g/reports/cls_web/load_test_summary.md
          echo "- Low: $(redis-cli llen ci:queue:low 2>/dev/null || echo 0)" >> g/reports/cls_web/load_test_summary.md
          echo "- Dead Letter: $(redis-cli llen ci:queue:dlq 2>/dev/null || echo 0)" >> g/reports/cls_web/load_test_summary.md

          cat g/reports/cls_web/load_test_summary.md

      - name: Stop services
        if: always()
        run: |
          echo "ğŸ›‘ Stopping services..."

          if [ -f /tmp/bridge.pid ]; then
            BRIDGE_PID=$(cat /tmp/bridge.pid)
            if ps -p $BRIDGE_PID > /dev/null; then
              kill -SIGTERM $BRIDGE_PID || true
              echo "CLS Web Bridge stopped"
            fi
          fi

          if [ -f /tmp/coordinator.pid ]; then
            COORD_PID=$(cat /tmp/coordinator.pid)
            if ps -p $COORD_PID > /dev/null; then
              kill -SIGTERM $COORD_PID || true
              echo "CI Coordinator stopped"
            fi
          fi

      - name: Upload health reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cls-web-health-report-${{ matrix.component }}
          path: |
            g/reports/cls_web/phase20_health_latest.json
            g/reports/cls_web/coordinator_health_latest.json
            g/reports/cls_web/load_test_summary.md
          if-no-files-found: warn

      - name: Upload session reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cls-web-session-reports-${{ matrix.component }}
          path: g/reports/cls_web/session_*.json
          if-no-files-found: warn

      - name: Upload DLQ reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cls-web-dlq-reports-${{ matrix.component }}
          path: g/reports/cls_web/dlq_*.json
          if-no-files-found: ignore

      - name: Upload service logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cls-web-logs-${{ matrix.component }}
          path: logs/*.log
          if-no-files-found: warn

  # ============================================================
  # SUMMARY JOB: Aggregate results
  # ============================================================
  cls-web-summary:
    name: CLS Web Test Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: cls-web-load-test
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Phase 20: CLS Web Integration Load Test Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Test results:"
          echo "  cls-web-load-test: ${{ needs.cls-web-load-test.result }}"
          echo ""

          if [ "${{ needs.cls-web-load-test.result }}" == "success" ]; then
            echo "âœ… All CLS Web load tests passed"
          else
            echo "âš ï¸ Some tests did not pass (continue-on-error enabled)"
          fi
          echo ""
          echo "ğŸ“Š Check artifacts for detailed reports:"
          echo "  - cls-web-health-report-*"
          echo "  - cls-web-session-reports-*"
          echo "  - cls-web-dlq-reports-*"
          echo "  - cls-web-logs-*"
