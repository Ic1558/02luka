name: Delegation Watchdog

on:
  schedule:
    - cron: "*/20 * * * *"
  workflow_dispatch:
  push:
    paths:
      - "hub/delegation_watchdog.mjs"
      - "tools/cls_force_wo_hook.zsh"
      - "config/delegation_watchdog.yaml"
      - "config/schemas/delegation_watchdog.schema.json"
      - ".github/workflows/delegation-watchdog.yml"

permissions:
  contents: write

env:
  MAINTENANCE_MODE: ${{ vars.MAINTENANCE_MODE }}

concurrency:
  group: delegation-watchdog-${{ github.ref }}
  cancel-in-progress: true

jobs:
  watchdog:
    runs-on: ubuntu-latest
    timeout-minutes: 4
    steps:
      - name: Maintenance guard
        if: env.MAINTENANCE_MODE == '1'
        run: echo "Repo in maintenance mode; skipping." && exit 0

      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-node@v4
        with: { node-version: '20' }

      - name: Install ajv-cli
        run: npm i -g ajv-cli@5

      - name: Validate config schema
        run: |
          # Use draft-07 schema (ajv-cli@5 supports draft-07, not draft-2020-12)
          ajv validate --strict=true \
            -s config/schemas/delegation_watchdog.schema.json \
            -d config/delegation_watchdog.yaml || exit 1

      - name: Run watchdog
        run: |
          # Use GITHUB_WORKSPACE instead of $HOME/02luka to ensure script writes to correct location
          # Script writes to LUKA_HOME/hub/delegation_watchdog.json, so we need LUKA_HOME to match workspace
          LUKA_HOME="$GITHUB_WORKSPACE" node hub/delegation_watchdog.mjs
          test -f hub/delegation_watchdog.json
          node -e "JSON.parse(require('fs').readFileSync('hub/delegation_watchdog.json','utf8'))"

      - name: Force WO if stuck
        run: |
          chmod +x tools/cls_force_wo_hook.zsh
          # If any stuck=true → trigger (CI uses DRY_RUN=1 for safety)
          # Use GITHUB_WORKSPACE to match the path used in Run watchdog step
          if jq -e '.items[]?|select(.stuck==true)' hub/delegation_watchdog.json >/dev/null; then
            echo "Stuck tasks detected → running hook (CI DRY_RUN=1)"
            DRY_RUN=1 LUKA_HOME="$GITHUB_WORKSPACE" tools/cls_force_wo_hook.zsh
          else
            echo "No stuck tasks."
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: delegation-watchdog
          path: hub/delegation_watchdog.json

      - name: Commit snapshot (main only)
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          if ! git diff --quiet -- hub/delegation_watchdog.json; then
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            git config user.name  "02LUKA Bot"
            git config user.email "bot@02luka.local"
            git add hub/delegation_watchdog.json
            git commit -m "chore(hub): update delegation_watchdog snapshot"
            git push
          else
            echo "No changes to commit."
          fi
