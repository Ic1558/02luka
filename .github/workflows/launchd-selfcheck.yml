name: LaunchAgent Self-Recovery Check

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:
  push:
    paths:
      - "tools/launchd_selfcheck.zsh"
      - ".github/workflows/launchd-selfcheck.yml"

permissions:
  contents: write

concurrency:
  group: launchd-selfcheck-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sanity:
    name: Sanity Gate
    runs-on: ubuntu-latest
    steps:
      - name: Determine OS flag
        shell: bash
        run: |
          # Running on ubuntu-latest, so IS_MAC=0
          echo "IS_MAC=0" >> "$GITHUB_ENV"
      - name: Load CI_STRICT
        shell: bash
        run: |
          # Prefer shell fallback over GitHub expression to avoid editor schema false-positives
          VAL="${{ vars.CI_STRICT }}"
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
      - run: |
          echo "CI_STRICT=$CI_STRICT  IS_MAC=$IS_MAC"
          echo "::notice ::Soft-green gate. Set repo variable CI_STRICT=1 to enable heavy jobs."
          if [ "${CI_STRICT}" != "1" ]; then
            echo "Soft-green: skipping heavy jobs (set CI_STRICT=1 to enable)"
            exit 0
          fi

  selfcheck:
    name: LaunchAgent Health Snapshot
    runs-on: macos-latest
    timeout-minutes: 5

    steps:
      - name: Load CI_STRICT
        shell: bash
        run: |
          # Prefer shell fallback over GitHub expression to avoid editor schema false-positives
          VAL="${{ vars.CI_STRICT }}"
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
      - name: Check CI_STRICT
        if: env.CI_STRICT != '1'
        run: |
          echo "Soft-green: skipping selfcheck (set CI_STRICT=1 to enable)"
          exit 0
      - name: Determine OS flag
        shell: bash
        run: |
          # Running on macos-latest, so IS_MAC=1
          echo "IS_MAC=1" >> "$GITHUB_ENV"
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Ensure hub dir
        run: mkdir -p hub

      - name: Run selfcheck (allow empty, no self-heal in CI)
        shell: zsh {0}
        run: |
          chmod +x tools/launchd_selfcheck.zsh
          ALLOW_EMPTY=1 SELF_HEAL=0 OUT=hub/selfcheck_report.json tools/launchd_selfcheck.zsh
          test -f hub/selfcheck_report.json
          node -e "JSON.parse(require('fs').readFileSync('hub/selfcheck_report.json','utf8'))"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: launchd-selfcheck
          path: hub/selfcheck_report.json

      - name: Commit snapshot (main only)
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          if ! git diff --quiet -- hub/selfcheck_report.json; then
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            git config user.name  "02LUKA Bot"
            git config user.email "bot@02luka.local"
            git add hub/selfcheck_report.json
            git commit -m "chore(hub): update LaunchAgent selfcheck snapshot"
            git push
          else
            echo "No changes to commit."
          fi
