---
name: Memory Consistency & Checksum Auditor

# Phase 21.2 - SOT Memory Verification with SHA-256 checksums

on:
  # Manual trigger with dispatch event
  workflow_dispatch:
    inputs:
      alert_on_mismatch:
        description: 'Alert if mismatch count > 0'
        required: false
        default: true
        type: boolean

      force_full_scan:
        description: 'Force full directory scan'
        required: false
        default: false
        type: boolean

  # Callable workflow
  workflow_call:
    inputs:
      alert_on_mismatch:
        description: 'Alert if mismatch count > 0'
        required: false
        default: true
        type: boolean

      force_full_scan:
        description: 'Force full directory scan'
        required: false
        default: false
        type: boolean

  # Scheduled audit (daily at 03:00 UTC / 10:00 ICT)
  schedule:
    - cron: '0 3 * * *'

  # Trigger via repository_dispatch
  repository_dispatch:
    types: [memory:audit]

jobs:
  memory-audit:
    name: Audit Memory Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          echo "âœ… Dependencies installed"

      - name: Create output directories
        run: |
          mkdir -p hub
          mkdir -p g/reports
          mkdir -p g/telemetry
          echo "âœ… Output directories created"

      - name: "Debug: Log resolved input values"
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Memory Audit - Input Resolution Debug"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Trigger: ${{ github.event_name }}"
          echo ""
          echo "Input values (raw):"
          echo "  alert_on_mismatch: '${{ inputs.alert_on_mismatch }}'"
          echo "  force_full_scan: '${{ inputs.force_full_scan }}'"
          echo ""
          echo "Resolved for env (booleans):"
          echo "  ALERT_ON_MISMATCH: ${{ inputs.alert_on_mismatch || true }}"
          echo "  FORCE_FULL_SCAN: ${{ inputs.force_full_scan || false }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Run Memory Audit
        id: audit
        run: |
          echo "ğŸ” Starting memory consistency audit..."
          echo ""

          if node hub/memory_audit.mjs; then
            echo "audit_status=pass" >> $GITHUB_OUTPUT
            echo "âœ… Audit completed successfully"
          else
            echo "audit_status=fail" >> $GITHUB_OUTPUT
            echo "âŒ Audit failed - integrity issues detected"
            exit 1
          fi
        env:
          # Note: These env vars are reserved for future use
          # The script currently reads configuration from config/memory_audit.yaml
          FORCE_FULL_SCAN: ${{ inputs.force_full_scan || false }}
          ALERT_ON_MISMATCH: ${{ inputs.alert_on_mismatch || true }}

      - name: Display Audit Report
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Memory Audit Report"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ -f hub/memory_audit.json ]; then
            cat hub/memory_audit.json | head -100
          else
            echo "âš ï¸  No audit report found"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check for mismatches
        if: always()
        id: check_mismatches
        run: |
          if [ -f hub/memory_audit.json ]; then
            MISMATCHES=$(node -e "
              const fs = require('fs');
              const report = JSON.parse(fs.readFileSync('hub/memory_audit.json', 'utf-8'));
              const total =
                (report.summary?.checksum_mismatches || 0) +
                (report.summary?.missing_required || 0) +
                (report.summary?.broken_references || 0);
              console.log(total);
            ")

            echo "mismatch_count=$MISMATCHES" >> $GITHUB_OUTPUT

            if [ "$MISMATCHES" -gt 0 ]; then
              echo "âš ï¸  Found $MISMATCHES integrity issues"
              echo "has_mismatches=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… No integrity issues found"
              echo "has_mismatches=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_mismatches=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Upload Audit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: memory-audit-report-${{ github.run_number }}
          path: |
            hub/memory_audit.json
            g/reports/memory_audit.log
            g/telemetry/memory_audit.jsonl
          if-no-files-found: warn
          retention-days: 90

      - name: Create Issue on Failure
        if: failure() && steps.check_mismatches.outputs.has_mismatches == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reportSummary = 'Audit report not available';

            try {
              const report = JSON.parse(fs.readFileSync('hub/memory_audit.json', 'utf-8'));

              reportSummary = `
            ## ğŸ” Memory Consistency Audit Failed

            **Audit ID:** \`${report.audit_id}\`
            **Timestamp:** ${report.timestamp}
            **Status:** âŒ ${report.status.toUpperCase()}

            ### Summary
            - **Total Files Scanned:** ${report.summary.total_files}
            - **Index Files:** ${report.summary.index_files}
            - **Snapshot Files:** ${report.summary.snapshot_files}
            - **Attestation Files:** ${report.summary.attestation_files}

            ### Issues Detected
            - âš ï¸ **Missing Required Files:** ${report.summary.missing_required}
            - âš ï¸ **Checksum Mismatches:** ${report.summary.checksum_mismatches}
            - âš ï¸ **Broken References:** ${report.summary.broken_references}
            - âš ï¸ **Orphaned Files:** ${report.summary.orphaned_files}

            ### Alerts
            ${report.alerts.map(a => `- **[${a.level.toUpperCase()}]** ${a.message}`).join('\n')}

            ### Action Required
            1. Review the audit report artifact
            2. Investigate checksum mismatches
            3. Verify snapshot integrity
            4. Re-run audit after fixes

            **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            } catch (error) {
              reportSummary = `Failed to read audit report: ${error.message}`;
            }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Memory Audit] Integrity Issues Detected - Run #${{ github.run_number }}`,
              body: reportSummary,
              labels: ['memory-audit', 'integrity-issue', 'automated']
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Workflow Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "   Audit Status: ${{ steps.audit.outputs.audit_status }}"
          echo "   Mismatches: ${{ steps.check_mismatches.outputs.mismatch_count }}"
          echo "   Run: ${{ github.run_number }}"
          echo "   Triggered by: ${{ github.event_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
