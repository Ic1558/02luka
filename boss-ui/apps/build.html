<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Build · Luka Workspace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/shared/ui.css">
</head>
<body>
  <noscript>This workspace requires JavaScript.</noscript>
  <script src="/shared/config-loader.js"></script>
  <script type="module">
    import { ensureConfigReady } from '/shared/config.js';
    import { API } from '/shared/api.js';
    import { mountAppShell, createPanel, hydrateStatus, showResult, showError } from '/shared/components.js';

    await ensureConfigReady();

    const { main, statusBar } = mountAppShell({
      active: 'build',
      title: 'Build · Luka Workspace',
      subtitle: 'Stage diffs and apply patches through Luka'
    });

    hydrateStatus(statusBar);

    const panel = createPanel('Prepare patch payload', 'Provide a summary, target file path, and diff. Run dry-runs before applying.');

    const form = document.createElement('form');
    form.className = 'form-grid';

    const summary = document.createElement('input');
    summary.type = 'text';
    summary.name = 'summary';
    summary.placeholder = 'Summary of changes';
    form.appendChild(summary);

    const pathInput = document.createElement('input');
    pathInput.type = 'text';
    pathInput.name = 'path';
    pathInput.placeholder = 'Relative path of file to patch (e.g. README.md)';
    form.appendChild(pathInput);

    const diff = document.createElement('textarea');
    diff.name = 'diff';
    diff.placeholder = 'Paste a unified diff. Example:\n\n--- a/file.txt\n+++ b/file.txt\n@@';
    diff.required = true;
    form.appendChild(diff);

    const dryRunWrapper = document.createElement('label');
    dryRunWrapper.style.display = 'flex';
    dryRunWrapper.style.alignItems = 'center';
    dryRunWrapper.style.gap = '8px';

    const dryRun = document.createElement('input');
    dryRun.type = 'checkbox';
    dryRun.name = 'dryRun';
    dryRun.checked = true;
    dryRunWrapper.appendChild(dryRun);
    dryRunWrapper.appendChild(document.createTextNode('Dry run (recommended)'));

    const actions = document.createElement('div');
    actions.className = 'form-actions';
    actions.appendChild(dryRunWrapper);

    const submit = document.createElement('button');
    submit.type = 'submit';
    submit.textContent = 'Send Patch';
    actions.appendChild(submit);

    const reset = document.createElement('button');
    reset.type = 'button';
    reset.className = 'secondary';
    reset.textContent = 'Clear';
    actions.appendChild(reset);

    form.appendChild(actions);
    panel.appendChild(form);

    const output = document.createElement('pre');
    output.className = 'output';
    output.textContent = 'Patch responses will appear here.';
    panel.appendChild(output);

    reset.addEventListener('click', () => {
      summary.value = '';
      pathInput.value = '';
      diff.value = '';
      dryRun.checked = true;
      output.textContent = 'Patch responses will appear here.';
      summary.focus();
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!diff.value.trim()) {
        diff.focus();
        return;
      }
      submit.disabled = true;
      output.textContent = 'Submitting patch...';
      try {
        const patches = [];
        const trimmedPath = pathInput.value.trim();
        if (trimmedPath) {
          patches.push({ path: trimmedPath, diff: diff.value });
        } else {
          patches.push({ path: 'patch.diff', diff: diff.value });
        }
        const payload = {
          dryRun: dryRun.checked,
          summary: summary.value.trim(),
          patches
        };
        const response = await API.patch(payload);
        showResult(output, response);
      } catch (err) {
        showError(output, err);
      } finally {
        submit.disabled = false;
      }
    });

    main.appendChild(panel);
  </script>
</body>
</html>
