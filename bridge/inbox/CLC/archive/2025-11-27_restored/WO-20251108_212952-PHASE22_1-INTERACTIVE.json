{
  "wo_id": "PHASE22_1-INTERACTIVE",
  "task_type": "apply_patch",
  "title": "Phase 22.1 ‚Äî Telemetry Dashboard v1 (Interactive Features)",
  "description": "Enhance Phase 22 v0 dashboard with auto-refresh, filters, CSV export, enhanced stats. Pure client-side, zero npm, < 7KB total.",
  "depends_on": "Phase 22 v0 merged",
  "files": {
    "hub/ui/telemetry.js": "// Phase 22.1 - Interactive Telemetry Dashboard\n// Auto-refresh, filters, CSV export, enhanced stats\n\nlet allEvents = [];\nlet autoRefreshInterval = null;\nlet refreshRate = 10000; // 10s default\nlet filters = {\n  agent: 'all',\n  event: 'all',\n  status: 'all',\n  timeRange: 'all'\n};\n\nasync function load() {\n  const tbody = document.querySelector('#tbl tbody');\n  const stats = document.querySelector('#stats');\n  try {\n    const res = await fetch('/telemetry/unified.jsonl');\n    if (!res.ok) throw new Error('fetch failed');\n    const text = await res.text();\n    allEvents = text.trim().split(/\\n+/).filter(Boolean).map(JSON.parse);\n    \n    // Update filter options\n    updateFilterOptions();\n    \n    // Apply filters and render\n    const filtered = applyFilters(allEvents);\n    renderTable(filtered);\n    renderStats(filtered, allEvents.length);\n    updateLastRefresh();\n  } catch (e) {\n    stats.innerHTML = '<span class=chip>‚ö†Ô∏è no telemetry yet</span>';\n  }\n}\n\nfunction renderTable(events) {\n  const tbody = document.querySelector('#tbl tbody');\n  tbody.innerHTML = '';\n  for (const row of events) {\n    const tr = document.createElement('tr');\n    tr.innerHTML = `<td>${row.ts}</td><td>${row.agent}</td><td>${row.event}</td><td>${row.ok ? '‚úì' : '‚úó'}</td><td><pre style=\"margin:0;white-space:pre-wrap\">${JSON.stringify(row.detail||{},null,0)}</pre></td>`;\n    tbody.appendChild(tr);\n  }\n}\n\nfunction renderStats(filtered, total) {\n  const ok = filtered.filter(e => e.ok).length;\n  const fail = filtered.filter(e => !e.ok).length;\n  const rate = total > 0 ? ((ok / filtered.length) * 100).toFixed(1) : '0.0';\n  const agents = [...new Set(filtered.map(e => e.agent))].length;\n  const events = [...new Set(filtered.map(e => e.event))].length;\n  \n  const stats = document.querySelector('#stats');\n  stats.innerHTML = `\n    <span class=chip>üìä Total: ${filtered.length}${filtered.length !== total ? ' (filtered)' : ''}</span>\n    <span class=chip>‚úÖ OK: ${ok} (${rate}%)</span>\n    <span class=chip>‚ùå Fail: ${fail}</span>\n    <span class=chip>ü§ñ Agents: ${agents}</span>\n    <span class=chip>‚ö° Events: ${events}</span>\n  `;\n}\n\nfunction updateFilterOptions() {\n  const agentSelect = document.querySelector('#filter-agent');\n  const eventSelect = document.querySelector('#filter-event');\n  \n  const agents = [...new Set(allEvents.map(e => e.agent))].sort();\n  const events = [...new Set(allEvents.map(e => e.event))].sort();\n  \n  agentSelect.innerHTML = '<option value=\"all\">All Agents</option>' + \n    agents.map(a => `<option value=\"${a}\">${a} (${allEvents.filter(e => e.agent === a).length})</option>`).join('');\n  \n  eventSelect.innerHTML = '<option value=\"all\">All Events</option>' + \n    events.map(ev => `<option value=\"${ev}\">${ev} (${allEvents.filter(e => e.event === ev).length})</option>`).join('');\n}\n\nfunction applyFilters(events) {\n  return events.filter(e => {\n    if (filters.agent !== 'all' && e.agent !== filters.agent) return false;\n    if (filters.event !== 'all' && e.event !== filters.event) return false;\n    if (filters.status === 'ok' && !e.ok) return false;\n    if (filters.status === 'fail' && e.ok) return false;\n    \n    if (filters.timeRange !== 'all') {\n      const eventTime = new Date(e.ts);\n      const now = new Date();\n      const cutoff = now - filters.timeRange;\n      if (eventTime < cutoff) return false;\n    }\n    \n    return true;\n  });\n}\n\nfunction startAutoRefresh() {\n  if (autoRefreshInterval) return;\n  autoRefreshInterval = setInterval(load, refreshRate);\n  document.querySelector('#auto-refresh-toggle').textContent = '‚è∏ Pause';\n}\n\nfunction stopAutoRefresh() {\n  if (autoRefreshInterval) {\n    clearInterval(autoRefreshInterval);\n    autoRefreshInterval = null;\n  }\n  document.querySelector('#auto-refresh-toggle').textContent = '‚ñ∂ Resume';\n}\n\nfunction toggleAutoRefresh() {\n  if (autoRefreshInterval) {\n    stopAutoRefresh();\n  } else {\n    startAutoRefresh();\n  }\n}\n\nfunction setRefreshRate(rate) {\n  refreshRate = rate * 1000;\n  if (autoRefreshInterval) {\n    stopAutoRefresh();\n    startAutoRefresh();\n  }\n}\n\nfunction updateLastRefresh() {\n  const el = document.querySelector('#last-refresh');\n  if (el) el.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;\n}\n\nfunction exportCSV() {\n  const data = applyFilters(allEvents);\n  let csv = 'timestamp,agent,event,ok,detail\\n';\n  \n  for (const row of data) {\n    const detail = JSON.stringify(row.detail || {}).replace(/\"/g, '\"\"');\n    csv += `\"${row.ts}\",\"${row.agent}\",\"${row.event}\",${row.ok},\"${detail}\"\\n`;\n  }\n  \n  const blob = new Blob([csv], { type: 'text/csv' });\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement('a');\n  a.href = url;\n  a.download = `telemetry-${Date.now()}.csv`;\n  a.click();\n  URL.revokeObjectURL(url);\n}\n\nfunction clearFilters() {\n  filters = { agent: 'all', event: 'all', status: 'all', timeRange: 'all' };\n  document.querySelector('#filter-agent').value = 'all';\n  document.querySelector('#filter-event').value = 'all';\n  document.querySelectorAll('input[name=status]').forEach(r => r.checked = r.value === 'all');\n  document.querySelector('#filter-time').value = 'all';\n  load();\n}\n\n// Event listeners\nwindow.addEventListener('load', () => {\n  load();\n  startAutoRefresh();\n  \n  // Pause when tab hidden\n  document.addEventListener('visibilitychange', () => {\n    if (document.hidden) {\n      stopAutoRefresh();\n    } else {\n      startAutoRefresh();\n    }\n  });\n  \n  // Filter change handlers\n  document.querySelector('#filter-agent').addEventListener('change', e => {\n    filters.agent = e.target.value;\n    load();\n  });\n  \n  document.querySelector('#filter-event').addEventListener('change', e => {\n    filters.event = e.target.value;\n    load();\n  });\n  \n  document.querySelectorAll('input[name=status]').forEach(radio => {\n    radio.addEventListener('change', e => {\n      filters.status = e.target.value;\n      load();\n    });\n  });\n  \n  document.querySelector('#filter-time').addEventListener('change', e => {\n    const value = e.target.value;\n    if (value === 'all') {\n      filters.timeRange = 'all';\n    } else {\n      filters.timeRange = parseInt(value) * 3600000; // hours to ms\n    }\n    load();\n  });\n});\n",
    "hub/ui/telemetry.html": "<!doctype html>\n<html lang=\"en\">\n<meta charset=\"utf-8\"/>\n<title>Telemetry Dashboard</title>\n<link rel=\"stylesheet\" href=\"/ui/telemetry.css\"/>\n<body>\n<main>\n  <header>\n    <h1>Unified Telemetry Dashboard</h1>\n    <div class=\"controls\">\n      <button id=\"auto-refresh-toggle\" onclick=\"toggleAutoRefresh()\">‚è∏ Pause</button>\n      <select onchange=\"setRefreshRate(this.value)\">\n        <option value=\"5\">5s</option>\n        <option value=\"10\" selected>10s</option>\n        <option value=\"30\">30s</option>\n        <option value=\"60\">60s</option>\n      </select>\n      <button onclick=\"exportCSV()\">‚¨á Export CSV</button>\n      <span id=\"last-refresh\" class=\"chip\">Last updated: --:--:--</span>\n    </div>\n  </header>\n  \n  <div class=\"filters\">\n    <select id=\"filter-agent\"><option value=\"all\">All Agents</option></select>\n    <select id=\"filter-event\"><option value=\"all\">All Events</option></select>\n    \n    <div class=\"radio-group\">\n      <label><input type=\"radio\" name=\"status\" value=\"all\" checked> All</label>\n      <label><input type=\"radio\" name=\"status\" value=\"ok\"> ‚úì OK Only</label>\n      <label><input type=\"radio\" name=\"status\" value=\"fail\"> ‚úó Fail Only</label>\n    </div>\n    \n    <select id=\"filter-time\">\n      <option value=\"all\">All Time</option>\n      <option value=\"1\">Last Hour</option>\n      <option value=\"24\">Last 24h</option>\n      <option value=\"168\">Last 7 Days</option>\n    </select>\n    \n    <button onclick=\"clearFilters()\">Clear Filters</button>\n  </div>\n  \n  <div id=\"stats\"></div>\n  \n  <table id=\"tbl\">\n    <thead>\n      <tr>\n        <th>Timestamp</th>\n        <th>Agent</th>\n        <th>Event</th>\n        <th>OK</th>\n        <th>Detail</th>\n      </tr>\n    </thead>\n    <tbody></tbody>\n  </table>\n  \n  <script src=\"/ui/telemetry.js\"></script>\n</main>\n</body>\n</html>\n",
    "hub/ui/telemetry.css": "main{font:14px/1.4 system-ui,Arial,sans-serif;padding:16px;max-width:1400px;margin:0 auto}\nheader{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}\nheader h1{margin:0;font-size:24px}\n.controls{display:flex;gap:8px;align-items:center}\nbutton,select{padding:6px 12px;border:1px solid #ccc;border-radius:4px;background:#fff;cursor:pointer;font-size:13px}\nbutton:hover,select:hover{background:#f5f5f5}\n.filters{display:flex;gap:8px;flex-wrap:wrap;padding:12px;background:#f9f9f9;border-radius:6px;margin-bottom:12px}\n.radio-group{display:flex;gap:12px;align-items:center}\n.radio-group label{display:flex;align-items:center;gap:4px;cursor:pointer}\ntable{border-collapse:collapse;width:100%;margin-top:12px}\nth,td{border:1px solid #ddd;padding:8px;text-align:left}\nthead th{background:#f5f5f5;font-weight:600}\ntbody tr:hover{background:#fafafa}\n#stats{margin:8px 0;display:flex;gap:12px;flex-wrap:wrap}\n.chip{padding:6px 10px;border-radius:8px;background:#eee;font-size:13px;white-space:nowrap}\n"
  },
  "edits": [],
  "post_verify": [
    "echo '‚úÖ Phase 22.1 files deployed'",
    "ls -lh hub/ui/telemetry.{html,js,css}"
  ],
  "acceptance_criteria": [
    "Auto-refresh works (default ON, 10s)",
    "Auto-refresh pauses when tab hidden",
    "Filters update dynamically",
    "CSV export includes filtered events",
    "Stats show success rate %",
    "File size < 7KB total"
  ]
}
