# Telemetry Unified Schema v1.1
# Phase 14.2 â€“ Telemetry Reliability Pack
# Last updated: 2025-11-06

version: "1.1"
description: |
  Unified telemetry event schema for 02luka ecosystem.
  All events must conform to this structure for validation and processing.

schema:
  required:
    - ts          # RFC3339 timestamp (UTC, Z suffix)
    - event       # Event name (dot-notation: component.action.detail)
    - component   # Source component
    - event_id    # SHA256 hash of canonical JSON

  fields:
    ts:
      type: string
      format: RFC3339
      description: "Event timestamp in UTC (YYYY-MM-DDTHH:MM:SSZ)"
      example: "2025-11-06T12:00:00Z"
      required: true

    event:
      type: string
      description: "Event name using dot notation"
      pattern: "^[a-z0-9._]+$"
      examples:
        - "bridge.sync.start"
        - "rag.ctx.hit"
        - "ingest.ok"
        - "system.heartbeat"
      required: true

    component:
      type: string
      enum:
        - gg        # GG (Golden Goose / LLM worker)
        - cls       # CLS (Command Line System)
        - cdc       # CDC (Change Data Capture)
        - gm        # GM (Global Manager)
        - bridge    # Bridge service
        - rag       # RAG (Retrieval Augmented Generation)
        - router    # Router/Gateway
      description: "Source component identifier"
      required: true

    level:
      type: string
      enum:
        - debug
        - info
        - warn
        - error
      default: info
      description: "Log level / severity"
      required: false

    data:
      type: object
      description: "Arbitrary event payload (JSON object)"
      default: {}
      required: false
      examples:
        - {"query": "Telemetry Schema", "hits": 4}
        - {"batch": 1, "count": 20}
        - {"duration_ms": 123.45}

    duration_ms:
      type: number
      description: "Operation duration in milliseconds"
      required: false
      example: 123.45

    batch_id:
      type: string
      description: "Batch identifier for grouped operations"
      required: false
      example: "batch-20251106-001"

    event_id:
      type: string
      format: sha256
      description: "SHA256 hash of canonical JSON (sorted keys, no whitespace)"
      pattern: "^[a-f0-9]{64}$"
      required: true
      example: "a1b2c3d4e5f6789012345678901234567890123456789012345678901234abcd"

    source:
      type: string
      description: "Source path or agent name"
      required: false
      examples:
        - "tools/rag_query.zsh"
        - "agents/kim"
        - "/home/user/02luka/bridge/sync.py"

    __normalized:
      type: boolean
      default: true
      description: "Internal flag indicating schema conformance"
      required: false

validation_rules:
  - "All required fields must be present"
  - "ts must match RFC3339 format with Z suffix"
  - "event_id must be SHA256 hash of canonical JSON"
  - "No duplicate event_id values within same file"
  - "component must be one of enumerated values"
  - "level defaults to 'info' if not specified"

notes:
  - "Use tools/telemetry_emit.zsh to generate conformant events"
  - "Use tools/telemetry_validate.zsh to validate JSONL files"
  - "Events are stored in JSONL format (one JSON object per line)"
  - "Canonical JSON for event_id: sorted keys, compact (no spaces)"
