# AP/IO v3.1 Protocol Documentation

**Version:** 3.1  
**Date:** 2025-11-16  
**Status:** Active

---

## Overview

AP/IO (Application Protocol / Input-Output) v3.1 is a standardized protocol for agent event logging and cross-agent communication in the 02LUKA system.

---

## Protocol Format

### Message Structure

```json
{
  "protocol": "AP/IO",
  "version": "3.1",
  "agent": "cls",
  "timestamp": "2025-11-16T02:12:34+07:00",
  "correlation_id": "corr-20251116-001",
  "session_id": "2025-11-16_cls_001",
  "event": {
    "type": "task_result",
    "task_id": "wo-251116-agents-layout",
    "source": "gg_orchestrator",
    "summary": "Completed /agents layout SPEC + PLAN"
  },
  "data": {
    "status": "success",
    "duration_sec": 132,
    "files_touched": ["path1", "path2"],
    "metadata": {
      "complexity": "medium",
      "risk_level": "guarded",
      "impact_zone": "normal_code"
    }
  },
  "routing": {
    "targets": ["cls", "andy"],
    "broadcast": false,
    "priority": "normal",
    "delivered_to": []
  }
}
```

---

## Required Fields

- `protocol` - Must be "AP/IO"
- `version` - Must be "3.1"
- `agent` - Agent identifier (cls, andy, hybrid, liam, gg, kim)
- `timestamp` - ISO-8601 timestamp with timezone
- `event` - Event object (required)
  - `type` - Event type (required)

---

## Event Types

- `heartbeat` - Agent alive signal
- `task_start` - Task initiated
- `task_result` - Task completed
- `error` - Error occurred
- `info` - General information
- `routing_request` - Request event routing
- `correlation_query` - Query correlated events

---

## Routing

### Single Agent
```json
{
  "routing": {
    "targets": ["cls"],
    "broadcast": false,
    "priority": "normal"
  }
}
```

### Multiple Agents
```json
{
  "routing": {
    "targets": ["cls", "andy"],
    "broadcast": false,
    "priority": "high"
  }
}
```

### Broadcast
```json
{
  "routing": {
    "targets": [],
    "broadcast": true,
    "priority": "critical"
  }
}
```

### Priority Levels
- `critical` - Immediate delivery
- `high` - Priority queue
- `normal` - Standard queue (default)
- `low` - Background processing

---

## Correlation

Events can be correlated using `correlation_id`:
- Format: `corr-YYYYMMDD-NNN`
- Used to link related events across agents
- Enables cross-agent event tracking

---

## Ledger Extension Fields

AP/IO v3.1 includes extension fields for enhanced tracking and correlation:

### ledger_id

**Format:** `ledger-YYYYMMDD-HHMMSS-<agent>-<seq>`

**Description:** Unique identifier for each ledger entry, auto-generated by the writer.

**Example:**
```json
{
  "ledger_id": "ledger-20251116-021234-cls-001"
}
```

**Generation:**
- Date: `YYYYMMDD` (8 digits)
- Time: `HHMMSS` (6 digits)
- Agent: Lowercase agent identifier
- Sequence: Incremental number for entries with same timestamp

### parent_id

**Format:** `parent-<type>-<id>`

**Description:** Links ledger entry to parent WO, event, or session. Enables tracking of event hierarchies and relationships.

**Types:**
- `wo` - Work Order ID
- `event` - Parent event ID
- `session` - Session ID

**Examples:**
```json
{
  "parent_id": "parent-wo-wo-251116-test"
}
```

```json
{
  "parent_id": "parent-event-event-12345"
}
```

```json
{
  "parent_id": "parent-session-2025-11-16_cls_001"
}
```

**Usage:**
- Link task results to originating WO
- Track event chains across agents
- Correlate related operations
- Build execution trees

### execution_duration_ms

**Type:** `number` (milliseconds)

**Description:** Precise execution duration in milliseconds. More accurate than `duration_sec` for short operations.

**Example:**
```json
{
  "data": {
    "status": "success",
    "duration_sec": 1.25,
    "execution_duration_ms": 1250
  }
}
```

**Benefits:**
- Millisecond precision for performance analysis
- Better accuracy for short operations (< 1 second)
- Can coexist with `duration_sec` for backward compatibility

### Complete Example

```json
{
  "protocol": "AP/IO",
  "version": "3.1",
  "ledger_id": "ledger-20251116-021234-cls-001",
  "parent_id": "parent-wo-wo-251116-test",
  "ts": "2025-11-16T02:12:34+07:00",
  "agent": "cls",
  "correlation_id": "corr-20251116-001",
  "session_id": "2025-11-16_cls_001",
  "event": {
    "type": "task_result",
    "task_id": "wo-251116-test",
    "source": "gg_orchestrator",
    "summary": "Task completed"
  },
  "data": {
    "status": "success",
    "duration_sec": 1.25,
    "execution_duration_ms": 1250,
    "files_touched": ["file1.js", "file2.js"]
  },
  "routing": {
    "targets": ["cls"],
    "broadcast": false,
    "priority": "normal"
  }
}
```

### Schema Reference

See `schemas/ap_io_v31_ledger.schema.json` for complete field definitions and validation rules.

---

## Backward Compatibility

AP/IO v3.1 supports Agent Ledger v1.0 format:
- v1.0 entries are automatically converted to v3.1 structure
- Reader supports both formats
- Writer generates v3.1 format only
- Extension fields (`ledger_id`, `parent_id`, `execution_duration_ms`) are optional for backward compatibility

---

## Validation

Use `tools/ap_io_v31/validator.zsh` to validate messages:
```bash
tools/ap_io_v31/validator.zsh message.json
echo '{"protocol":"AP/IO",...}' | tools/ap_io_v31/validator.zsh -
```

---

## Usage Examples

### Writing Events
```bash
tools/ap_io_v31/writer.zsh cls task_start "wo-test" "gg_orchestrator" "Starting test"
```

### Reading Events
```bash
tools/ap_io_v31/reader.zsh g/ledger/cls/2025-11-16.jsonl
tools/ap_io_v31/reader.zsh g/ledger/cls/2025-11-16.jsonl --agent cls --event task_result
```

### Routing Events
```bash
tools/ap_io_v31/router.zsh event.json --targets cls,andy
tools/ap_io_v31/router.zsh event.json --broadcast --priority high
```

---

## Schema

See `schemas/ap_io_v31.schema.json` for complete JSON Schema definition.

---

**Document Owner:** Liam  
**Last Updated:** 2025-11-16
