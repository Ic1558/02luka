# Claude PR Batch Reporting System

Automated batch report generation for Claude PR operations, tracking merged PRs, updated branches, time spent, and credits used.

## Overview

The batch reporting system generates timestamped reports in `g/reports/CLAUDE_PR_BATCH_<timestamp>.md` format, containing:

- ‚úÖ **Merged PRs** - PR number, title, branch, merge timestamp, and URL
- üîÑ **Updated Branches** - Branch name, commit SHA, message, and update timestamp
- ‚è±Ô∏è **Time Spent** - Total duration in milliseconds, seconds, and minutes
- üí∞ **Credits Used** - Total API credits consumed during the batch

## Architecture

### Components

1. **`skills/claude_pr_batch_report.py`** - Core report generation engine
   - Python class `ClaudePRBatchReport` for report generation
   - Markdown template rendering
   - File output to `g/reports/`

2. **`scripts/claude_batch_tracker.py`** - Batch tracking CLI
   - Maintains batch state in `g/metrics/claude_batch/current_batch.json`
   - Commands: `start`, `pr-merged`, `branch-updated`, `track-time`, `track-credits`, `status`, `report`
   - JSON output for automation integration

3. **`scripts/pr-automation/claude-batch-wrapper.zsh`** - Shell wrapper
   - Convenient shell functions for batch tracking
   - Integration with existing git workflows
   - Automatic time tracking for git operations

## Usage

### CLI Method

```bash
# Start a new batch
python3 scripts/claude_batch_tracker.py start

# Track a merged PR
python3 scripts/claude_batch_tracker.py pr-merged \
  --number 123 \
  --title "feat: add new feature" \
  --branch "feature/new-feature" \
  --url "https://github.com/owner/repo/pull/123"

# Track a branch update
python3 scripts/claude_batch_tracker.py branch-updated \
  --branch "main" \
  --sha "abc123def456" \
  --message "Update documentation"

# Track time spent (milliseconds)
python3 scripts/claude_batch_tracker.py track-time --duration 5000

# Track credits used
python3 scripts/claude_batch_tracker.py track-credits --amount 0.025

# Check current status
python3 scripts/claude_batch_tracker.py status

# Generate final report
python3 scripts/claude_batch_tracker.py report
```

### Shell Wrapper Method

```bash
# Load the wrapper functions
source scripts/pr-automation/claude-batch-wrapper.zsh

# Start a new batch
claude_batch_start

# Track operations
claude_batch_track_pr 123 "feat: add feature" "feature/branch"
claude_batch_track_branch "main" "abc123" "Update docs"
claude_batch_track_time 5000
claude_batch_track_credits 0.025

# Check status
claude_batch_status

# Generate report
claude_batch_report

# Git operations with automatic tracking
claude_batch_git_push "feature/branch"
```

### Python API Method

```python
from skills.claude_pr_batch_report import ClaudePRBatchReport

# Create reporter
reporter = ClaudePRBatchReport()

# Set batch times
reporter.set_batch_times(start_time="2025-11-06T09:00:00")

# Add data
reporter.add_merged_pr(
    pr_number=123,
    title="feat: add new feature",
    branch="feature/branch",
    url="https://github.com/owner/repo/pull/123"
)

reporter.add_updated_branch(
    branch_name="main",
    commit_sha="abc123def456",
    commit_message="Update documentation"
)

reporter.track_time(5000)  # 5 seconds
reporter.track_credits(0.025)

# Generate report
result = reporter.generate_report()
print(f"Report saved to: {result['filepath']}")
```

## Report Format

Generated reports follow this structure:

```markdown
# Claude PR Batch Report

**Generated:** 2025-11-06 09:17:10
**Batch Period:** 2025-11-06T09:16:25 ‚Üí 2025-11-06T09:17:10

---

## üìä Batch Summary

- **Merged PRs:** 1
- **Updated Branches:** 1
- **Time Spent:** 0.26 minutes (15.43 seconds)
- **Credits Used:** 0.0875

---

## ‚úÖ Merged PRs

### PR #123: feat: implement batch report generation

- **Branch:** `claude/batch-report-output-011CUrNgXP3ChtSNhyaJDwEV`
- **Merged At:** 2025-11-06T09:16:36.526891
- **URL:** https://github.com/Ic1558/02luka/pull/123

---

## üîÑ Updated Branches

| Branch | Commit | Message | Updated At |
|--------|--------|---------|------------|
| `claude/batch-report-output` | `abc12345` | feat(batch-reports): add automated... | 2025-11-06T09:16:45 |

---

## ‚è±Ô∏è Time & Credit Breakdown

- **Total Duration:** 15430 ms
- **Average Time per Operation:** 7715.00 ms
- **Credits Used:** 0.0875

---

_Report generated by Claude PR Batch Reporter_
```

## Integration with Existing Systems

### Agent System Integration

Add to `config/intent_map.yaml`:

```yaml
batch_report:
  skills:
    - name: claude_pr_batch_report.py
      params:
        action: generate
      timeout: 30
```

### GitHub Actions Integration

```yaml
- name: Generate Batch Report
  run: |
    python3 scripts/claude_batch_tracker.py start
    # ... PR operations ...
    python3 scripts/claude_batch_tracker.py report

- name: Upload Batch Report
  uses: actions/upload-artifact@v3
  with:
    name: batch-report
    path: g/reports/CLAUDE_PR_BATCH_*.md
```

### LaunchAgent Integration

For periodic batch reporting:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.02luka.claude_batch_report</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/bin/python3</string>
        <string>/path/to/scripts/claude_batch_tracker.py</string>
        <string>report</string>
    </array>
    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>17</integer>
        <key>Minute</key>
        <integer>0</integer>
    </dict>
    <key>StandardOutPath</key>
    <string>/path/to/logs/batch_report.log</string>
    <key>StandardErrorPath</key>
    <string>/path/to/logs/batch_report.err</string>
</dict>
</plist>
```

## State Management

### Batch State File

Location: `g/metrics/claude_batch/current_batch.json`

Structure:
```json
{
  "batch_id": "batch_20251106_091625",
  "start_time": "2025-11-06T09:16:25.590172",
  "end_time": null,
  "merged_prs": [
    {
      "number": 123,
      "title": "feat: add feature",
      "branch": "feature/branch",
      "merged_at": "2025-11-06T09:16:36.526891",
      "url": "https://github.com/owner/repo/pull/123"
    }
  ],
  "updated_branches": [
    {
      "branch": "main",
      "commit_sha": "abc123def456",
      "commit_message": "Update docs",
      "updated_at": "2025-11-06T09:16:45.588720"
    }
  ],
  "time_spent_ms": 15430,
  "credits_used": 0.0875
}
```

### State Archival

When a report is generated:
1. Current batch state is finalized with `end_time`
2. Report is generated to `g/reports/CLAUDE_PR_BATCH_<timestamp>.md`
3. State file is archived to `g/metrics/claude_batch/batch_<id>.json`
4. Ready for next batch

## Troubleshooting

### No Active Batch Error

```bash
# Check if a batch is active
python3 scripts/claude_batch_tracker.py status

# Start a new batch if needed
python3 scripts/claude_batch_tracker.py start
```

### Permission Errors

```bash
# Ensure scripts are executable
chmod +x scripts/claude_batch_tracker.py
chmod +x skills/claude_pr_batch_report.py
chmod +x scripts/pr-automation/claude-batch-wrapper.zsh

# Ensure directories exist
mkdir -p g/reports g/metrics/claude_batch
```

### Import Errors

```bash
# Ensure Python path includes the project root
export PYTHONPATH=/path/to/02luka:$PYTHONPATH

# Or use absolute paths
python3 /absolute/path/to/scripts/claude_batch_tracker.py
```

## Examples

### Example 1: Single PR Batch

```bash
# Start tracking
python3 scripts/claude_batch_tracker.py start

# Work on PR
# ... make changes ...

# Track the PR merge
python3 scripts/claude_batch_tracker.py pr-merged \
  --number 456 \
  --title "fix: resolve authentication bug" \
  --branch "fix/auth-bug"

# Track time (2.5 seconds)
python3 scripts/claude_batch_tracker.py track-time --duration 2500

# Track credits
python3 scripts/claude_batch_tracker.py track-credits --amount 0.015

# Generate report
python3 scripts/claude_batch_tracker.py report
```

### Example 2: Multi-PR Batch with Shell Wrapper

```bash
# Load wrapper
source scripts/pr-automation/claude-batch-wrapper.zsh

# Start batch
claude_batch_start

# Work on multiple PRs
claude_batch_track_pr 789 "feat: add dark mode" "feature/dark-mode"
claude_batch_track_pr 790 "docs: update README" "docs/readme"

# Track branch updates
claude_batch_git_push "feature/dark-mode"
claude_batch_git_push "docs/readme"

# Add manual time/credits
claude_batch_track_time 8500
claude_batch_track_credits 0.042

# Check status before reporting
claude_batch_status

# Generate final report
claude_batch_report
```

## Future Enhancements

- [ ] Automatic credit estimation based on model usage
- [ ] Integration with GitHub API for automatic PR data retrieval
- [ ] Batch comparison reports (compare multiple batches)
- [ ] CSV/JSON export formats
- [ ] Grafana dashboard integration
- [ ] Real-time batch monitoring dashboard
- [ ] Email/Slack notifications on batch completion
- [ ] Batch templates for common workflows

## Related Documentation

- [PR Automation Scripts](../scripts/pr-automation/README.md)
- [Agent System Architecture](./agent-system.md)
- [Reporting Infrastructure](./reporting.md)
- [Telemetry & Analytics](./telemetry.md)

---

**Created:** 2025-11-06
**Last Updated:** 2025-11-06
**Author:** Claude
**Version:** 1.0.0
