#!/usr/bin/env bash
#
# Example Conflict Hook
# This hook runs when a conflict is detected during rebase
#
# Arguments:
#   $1 = PR number
#   $2 = Branch name
#   $3 = Base branch
#
# To use: cp on_conflict.sh.example on_conflict.sh && chmod +x on_conflict.sh

set -euo pipefail

PR_NUM="$1"
BRANCH="$2"
BASE="${3:-origin/main}"

# Example: Create detailed conflict report
CONFLICT_DIR="/tmp/ci-rebase-conflicts"
mkdir -p "$CONFLICT_DIR"

REPORT="$CONFLICT_DIR/pr-${PR_NUM}-$(date +%Y%m%d_%H%M%S).txt"

cat > "$REPORT" <<EOF
Conflict Report for PR #$PR_NUM
================================

Branch: $BRANCH
Base: $BASE
Time: $(date -Iseconds)

Conflicting Files:
$(git status --short 2>/dev/null || echo "N/A")

Merge Base:
$(git merge-base origin/$BRANCH $BASE 2>/dev/null || echo "N/A")

Commits Behind:
$(git rev-list --count origin/$BRANCH..$BASE 2>/dev/null || echo "N/A")

Suggested Resolution:
1. Checkout the branch: git checkout $BRANCH
2. Rebase manually: git rebase $BASE
3. Resolve conflicts in the listed files
4. Continue: git rebase --continue
5. Push: git push --force-with-lease

EOF

echo "üìù Conflict report saved to: $REPORT"

# Example: Post comment to PR (requires gh CLI)
# gh pr comment "$PR_NUM" --body "‚ö†Ô∏è  Automatic rebase failed due to conflicts. See workflow logs for details."

exit 0
