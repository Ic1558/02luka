name: Auto-Index Memory Repository

on:
  push:
    branches: [main]
    paths:
      - 'hub/**'
      - '.github/workflows/auto-index.yml'
  workflow_dispatch:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  repository_dispatch:
    types: [memory-repo-updated]

permissions:
  contents: write

concurrency:
  group: auto-index-${{ github.ref }}
  cancel-in-progress: true

jobs:
  auto-index:
    if: ${{ !(github.event_name == 'push' && github.actor == 'github-actions[bot]') }}
    name: Auto-Index Memory Repo
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: code-repo

      - name: Memory self-check
        working-directory: code-repo
        run: |
          set -euo pipefail
          test -d _memory || { echo "ERR: _memory/ not found"; exit 1; }
          ls -la _memory | head -50
          test -f _memory/GG/context/LATEST.json || { echo "ERR: LATEST.json not found"; exit 1; }
          test -f _memory/GG/context/LATEST.meta.json || { echo "ERR: LATEST.meta.json not found"; exit 1; }
          # Validate meta.json has required fields (date/digest OR generated_at)
          jq -e '.generated_at or (.date and .digest)' _memory/GG/context/LATEST.meta.json >/dev/null || { echo "ERR: Invalid LATEST.meta.json structure"; exit 1; }
          echo "OK: _memory subtree present and GG/context latest files valid"

      - name: Setup Node.js with cache
        uses: ./code-repo/.github/actions/node-setup
        with:
          node-version: '20'
          install-dependencies: 'false'
          continue-on-error: 'true'
          lockfile: ''  # Empty to prevent cache path resolution when not installing deps

      - name: Ensure minimal deps for indexer (redis only)
        working-directory: code-repo/hub
        run: |
          set -euo pipefail
          # Check if redis is available using ES module syntax (since hub_autoindex.mjs uses import)
          if node --input-type=module -e "import('redis').then(() => console.log('‚úÖ redis available')).catch(() => process.exit(1))" 2>/dev/null; then
            echo "‚úÖ redis already available"
          else
            echo "üì¶ Installing minimal dependency: redis"
            # Ensure node_modules exists
            mkdir -p node_modules
            # Install redis (--no-save to avoid modifying package.json)
            npm install --no-audit --no-fund --no-save redis@^4
            echo "‚úÖ redis installed successfully"
          fi
          # Verify installation using ES module syntax (matches hub_autoindex.mjs)
          node --input-type=module -e "import('redis').then(() => console.log('‚úÖ redis module verified')).catch((e) => { console.error('‚ùå Failed to verify redis:', e.message); process.exit(1); })" || {
            echo "‚ùå Failed to verify redis installation"
            exit 1
          }

      - name: Run auto-indexer
        working-directory: code-repo
        env:
          LUKA_MEM_REPO_ROOT: ${{ github.workspace }}/code-repo/_memory
          HUB_INDEX_PATH: ${{ github.workspace }}/code-repo/hub/index.json
        run: |
          export REDIS_URL="${REDIS_URL:-redis://localhost:6379}"
          node hub/hub_autoindex.mjs

      - name: Generate MCP registry
        working-directory: code-repo
        run: |
          node hub/mcp_discovery.mjs
          test -f hub/mcp_registry.json || { echo "‚ùå mcp_registry.json not generated"; exit 1; }
          echo "‚úÖ MCP registry generated"

      - name: Assert MCP registry
        working-directory: code-repo
        run: |
          jq -e '._meta.source=="mcp_discovery.mjs"' hub/mcp_registry.json >/dev/null || { echo "‚ùå Invalid source"; exit 1; }
          jq -e '.servers | length >= 0' hub/mcp_registry.json >/dev/null || { echo "‚ùå Invalid servers array"; exit 1; }
          echo "‚úÖ MCP registry structure valid"
          # Note: local_02luka might not exist in CI (uses HOME fallback)
          CFG=$(jq -r '._meta.config_path // empty' hub/mcp_registry.json)
          if [ -n "$CFG" ] && [ ! -f "$CFG" ]; then
            echo "‚ö†Ô∏è  Warning: _meta.config_path points to a non-existent file in CI: $CFG"
          fi

      - name: Check if branch is protected
        id: check-protected
        run: |
          # Check if branch protection is enabled (non-fatal check)
          if [ "${{ github.ref_protected }}" = "true" ]; then
            echo "protected=true" >> "$GITHUB_OUTPUT"
            echo "üîí Branch is protected - push may require status checks"
          else
            echo "protected=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push index.json
        working-directory: code-repo
        run: |
          set -eo pipefail
          
          git config user.name "02LUKA Bot"
          git config user.email "bot@02luka.local"
          
          # Get current branch name (remove refs/heads/ prefix if present)
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          TARGET_BRANCH="${CURRENT_BRANCH#refs/heads/}"
          
          # Only push to main branch, skip for other branches (non-fatal)
          if [ "$TARGET_BRANCH" != "main" ]; then
            echo "‚ÑπÔ∏è  Current branch is '$TARGET_BRANCH' (not main)"
            echo "‚ÑπÔ∏è  Skipping push - commits will be included when this branch is merged to main"
            TARGET_BRANCH="main"  # Use main for commit detection, but skip push
            SKIP_PUSH=true
          else
            SKIP_PUSH=false
          fi
          
          # Stage without modifying index to detect changes against HEAD
          git add -N hub/index.json hub/mcp_registry.json 2>/dev/null || true
          
          if git status --porcelain hub/index.json hub/mcp_registry.json | grep -q .; then
            echo "üìù Changes detected in hub files"
            git add hub/index.json hub/mcp_registry.json
            
            # Commit changes (non-fatal - may fail if nothing to commit)
            git commit -m "chore(hub): Auto-update index & MCP registry [skip ci]" \
              -m "ü§ñ Automated update via GitHub Actions" \
              -m "Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com" || {
              echo "‚ö†Ô∏è  Commit failed (may be empty or already committed)"
              exit 0
            }
            
            # Skip push if not on main branch
            if [ "$SKIP_PUSH" = "true" ]; then
              echo "‚ÑπÔ∏è  Commit created locally on branch '$CURRENT_BRANCH'"
              echo "‚ÑπÔ∏è  Push skipped - will be included when branch is merged to main"
              exit 0
            fi
            
            # Push with retry logic (non-fatal for protected branches)
            # Default to false if check-protected step didn't run or output is missing
            IS_PROTECTED="${{ steps.check-protected.outputs.protected || 'false' }}"
            
            if [ "$IS_PROTECTED" = "true" ]; then
              echo "üîí Protected branch detected - attempting push (may be blocked by status checks)"
            fi
            
            attempt=0
            max_attempts=3
            push_success=false
            
            while [ $attempt -lt $max_attempts ]; do
              attempt=$((attempt + 1))
              
              # Capture push output and exit code
              if PUSH_OUTPUT=$(git push origin main 2>&1); then
                echo "‚úÖ Push succeeded on attempt $attempt"
                push_success=true
                break
              else
                PUSH_EXIT=$?
                echo "‚ö†Ô∏è  Push failed on attempt $attempt (exit code: $PUSH_EXIT)"
                echo "Push output: $PUSH_OUTPUT"
                
                # Check if failure is due to branch protection
                if echo "$PUSH_OUTPUT" | grep -qiE "protected branch|Required status check|remote rejected"; then
                  echo "üîí Push blocked by branch protection (status checks required)"
                  echo "‚ÑπÔ∏è  This is expected for protected branches; commit is created locally"
                  echo "‚ÑπÔ∏è  The commit will be included in the next successful push or manual merge"
                  push_success=false
                  break
                fi
                
                # Check if error is "src refspec main does not match any" (branch doesn't exist)
                if echo "$PUSH_OUTPUT" | grep -qiE "src refspec.*does not match"; then
                  echo "‚ö†Ô∏è  Branch 'main' does not exist in this checkout"
                  echo "‚ÑπÔ∏è  This can happen when running on non-main branches"
                  echo "‚ÑπÔ∏è  Commit is created locally and will be included when branch is merged"
                  push_success=false
                  break
                fi
                
                # For other errors, retry with pull-rebase
                if [ $attempt -lt $max_attempts ]; then
                  echo "üîÑ Pulling latest changes before retry..."
                  if git pull --rebase origin main; then
                    echo "‚úÖ Rebase successful, retrying push..."
                    sleep 2
                  else
                    echo "‚ùå Rebase failed - aborting push attempts"
                    exit 1
                  fi
                fi
              fi
            done
            
            if [ "$push_success" = "false" ] && [ "$IS_PROTECTED" != "true" ]; then
              echo "‚ö†Ô∏è  Push failed after $max_attempts attempts"
              echo "‚ÑπÔ∏è  Commit is created locally and will be included when branch is merged"
              exit 0  # Non-fatal - commit is created locally
            elif [ "$push_success" = "false" ]; then
              echo "‚ö†Ô∏è  Push blocked by branch protection (non-fatal for auto-updates)"
              exit 0
            fi
          else
            echo "‚ÑπÔ∏è  No changes to hub files - skipping commit"
          fi

  claude-metrics-publish:
    name: Publish Claude Metrics Badge
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: code-repo

      - name: Gate to 06:00 ICT only
        run: |
          set -euo pipefail
          # Run only at 23:00 UTC (06:00 ICT)
          if [[ "$(date -u +%H%M)" != "2300" ]]; then
            echo "Not 23:00 UTC; skipping metrics publish."
            exit 0
          fi

      - name: Prepare metrics snapshot
        working-directory: code-repo
        id: snap
        run: |
          set -euo pipefail
          Y=$(date -u +%Y%m)
          MET="g/reports/claude_code_metrics_${Y}.md"
          echo "yearmonth=$Y" >> "$GITHUB_OUTPUT"
          if [[ ! -f "$MET" ]]; then
            echo "No metrics file ($MET); nothing to publish."
            exit 0
          fi
          echo "metrics_present=true" >> "$GITHUB_OUTPUT"

      - name: Update README badges + metrics section
        if: steps.snap.outputs.metrics_present == 'true'
        working-directory: code-repo
        run: |
          set -euo pipefail
          Y="${{ steps.snap.outputs.yearmonth }}"
          MET="g/reports/claude_code_metrics_${Y}.md"
          README="README.md"
          BADGES_START="<!-- badges:start -->"
          BADGES_END="<!-- badges:end -->"

          AUTO_INDEX_BADGE='[![Auto-Index OK](https://img.shields.io/badge/Auto--Index-OK-brightgreen)](./.github/workflows/auto-index.yml)'
          PHASE15_BADGE='[![Phase15 OK](https://img.shields.io/badge/Phase15-OK-brightgreen)](./.github/workflows/phase15-quick-health.yml)'

          if [[ ! -f "$README" ]]; then
            echo "# 02luka" > "$README"
          fi

          # Insert or replace badges block
          if grep -q "$BADGES_START" "$README"; then
            awk -v start="$BADGES_START" -v end="$BADGES_END" -v a="$AUTO_INDEX_BADGE" -v p="$PHASE15_BADGE" '
              BEGIN{inblk=0}
              index($0,start){print start; print a " " p; inblk=1; next}
              index($0,end){print end; inblk=0; next}
              !inblk{print}
            ' "$README" > "$README.tmp" && mv "$README.tmp" "$README"
          else
            printf "%s\n%s %s\n%s\n\n" "$BADGES_START" "$AUTO_INDEX_BADGE" "$PHASE15_BADGE" "$BADGES_END" | cat - "$README" > "$README.tmp" && mv "$README.tmp" "$README"
          fi

          # Insert/update metrics preview block
          MET_START="<!-- metrics:start -->"
          MET_END="<!-- metrics:end -->"
          PREVIEW=$(printf "\n### Claude Code Metrics %s\n\n" "$Y"; sed -n '1,50p' "$MET")
          if grep -q "$MET_START" "$README"; then
            awk -v start="$MET_START" -v end="$MET_END" -v pre="$PREVIEW" '
              BEGIN{inblk=0}
              index($0,start){print start; print pre; inblk=1; next}
              index($0,end){print end; inblk=0; next}
              !inblk{print}
            ' "$README" > "$README.tmp" && mv "$README.tmp" "$README"
          else
            printf "\n%s\n%s\n%s\n" "$MET_START" "$PREVIEW" "$MET_END" >> "$README"
          fi

      - name: Commit and push README update
        if: steps.snap.outputs.metrics_present == 'true'
        working-directory: code-repo
        run: |
          set -euo pipefail
          git config user.name "02LUKA Bot"
          git config user.email "bot@02luka.local"
          git add README.md
          if git commit -m "docs(metrics): publish Claude metrics & badges [skip ci]"; then
            git push origin HEAD:main || true
            echo "README updated and pushed."
          else
            echo "No README changes to commit."
          fi
