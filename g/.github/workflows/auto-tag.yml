---
name: auto-tag
on:  # yamllint disable-line rule:truthy
  push:
    branches: [ main ]

permissions:
  contents: write

concurrency:
  group: auto-tag-${{ github.ref }}
  cancel-in-progress: false

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Compute and push tag
        shell: bash
        run: |
          set -euo pipefail
          # Ensure we have full tag history to avoid duplicate computations.
          git fetch --tags --force

          # Determine latest tag (vMA.MI.PA). If none, start from v0.0.0
          latest="$(git tag --list 'v*' --sort=-v:refname | head -n1 || true)"
          if [ -z "${latest:-}" ]; then
            latest="v0.0.0"
          fi

          ver="${latest#v}"
          IFS=. read -r MA MI PA <<<"${ver:-0.0.0}"
          : "${MA:=0}"; : "${MI:=0}"; : "${PA:=0}"

          new="v${MA}.${MI}.$((PA+1))"

          # If computed tag already exists (race), suffix with UTC timestamp for idempotence.
          if git rev-parse -q --verify "refs/tags/$new" >/dev/null; then
            echo "Tag $new already exists, appending timestamp suffix"
            new="${new}-$(date -u +%Y%m%d%H%M%S)"
          fi

          # Create annotated tag on the current commit (GITHUB_SHA).
          git tag -a "$new" -m "auto: tag $new" "${GITHUB_SHA}"

          # Push with small retry loop to mitigate concurrent taggers.
          attempt=0
          until git push origin "refs/tags/$new"; do
            attempt=$((attempt+1))
            if [ $attempt -ge 3 ]; then
              echo "Failed to push tag after $attempt attempts"
              exit 1
            fi
            echo "Retry $attempt after brief backoff..."
            sleep 2
            git fetch --tags --force
          done

          echo "new_tag=$new" >> "$GITHUB_OUTPUT"
          echo "Created and pushed tag: $new"
