name: Protection Enforcer
on:
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '27 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  sanity:
    name: Sanity Gate
    runs-on: ubuntu-latest
    steps:
      - name: Determine OS flag
        shell: bash
        run: |
          # Running on ubuntu-latest, so IS_MAC=0
          echo "IS_MAC=0" >> "$GITHUB_ENV"
      - name: Set CI_STRICT
        shell: bash
        run: |
          # Prefer shell fallback over GitHub expression to avoid editor schema false-positives
          VAL="${{ vars.CI_STRICT }}"
          if [ -z "$VAL" ]; then VAL=0; fi
          echo "CI_STRICT=$VAL" >> "$GITHUB_ENV"
      - run: |
          echo "CI_STRICT=$CI_STRICT  IS_MAC=$IS_MAC"
          echo "::notice ::Soft-green gate. Set repo variable CI_STRICT=1 to enable heavy jobs."
          if [ "${CI_STRICT}" != "1" ]; then
            echo "Soft-green: skipping heavy jobs (set CI_STRICT=1 to enable)"
            exit 0
          fi

  enforce:
    if: vars.CI_STRICT == '1'
    runs-on: ubuntu-latest
    steps:
      - name: Determine OS flag
        shell: bash
        run: |
          # Running on ubuntu-latest, so IS_MAC=0
          echo "IS_MAC=0" >> "$GITHUB_ENV"
      - uses: actions/checkout@v4

      - name: Assert required job IDs exist in workflows
        run: node tools/required_checks_assert.mjs

      - name: Comment guidance on mismatches (best-effort)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          body="Branch protection mismatch detected.
          Make sure required checks are exactly: \`$(jq -r '.required|join(", ")' config/required_checks.json)\`.
          If optional jobs are failing but block merge, unmark them in protection or fix them."
          gh pr comment "$PR_NUMBER" --body "$body" || true
