# Phase 21.4 â€“ System Telemetry Aggregator v2
# Classification: Unified Observability Layer
# Owner: GG Core (02LUKA Automation)
# Timestamp: 2025-11-08T00:00:00Z
# WO-ID: WO-251108-TELEMETRY-V2
# Notes: Aggregates telemetry from mcp_health, delegation_watchdog, bridge_selfcheck

aggregator:
  name: system-telemetry-v2
  description: "Unified telemetry feed from MCP health, delegation monitoring, and bridge self-checks"
  version: "2.0.0"

sources:
  # MCP Health Monitoring
  mcp_health:
    enabled: true
    type: file
    path: ~/02luka/g/reports/mcp_health/latest.md
    parser: markdown
    namespace: mcp
    metrics:
      - service_state
      - pid_status
      - exit_codes
      - error_logs

  # Delegation Watchdog (LaunchAgent monitoring)
  delegation_watchdog:
    enabled: true
    type: launchctl
    services:
      - com.02luka.optimizer
      - com.02luka.digest
      - com.02luka.mcp.fs
      - com.02luka.mcp.puppeteer
    namespace: delegation
    check_interval_seconds: 300
    metrics:
      - agent_state
      - agent_pid
      - last_exit_code
      - respawn_count

  # Bridge Self-Check (MCP WebBridge health endpoint)
  bridge_selfcheck:
    enabled: true
    type: http
    endpoint: http://127.0.0.1:3003/health
    timeout_ms: 5000
    namespace: bridge
    metrics:
      - http_status
      - response_time_ms
      - service_health
      - container_status

# Output configuration
output:
  format: json
  path: ~/02luka/hub/system_telemetry_v2.json
  backup_count: 10
  include_metadata: true

# Alerting thresholds
alerts:
  enabled: true
  channels:
    telegram:
      enabled: true
      webhook_env: TELEGRAM_BOT_WEBHOOK
      severity_threshold: warning
    loki:
      enabled: true
      endpoint: http://127.0.0.1:3100/loki/api/v1/push
      labels:
        job: system_telemetry_v2
        environment: production

  rules:
    - name: mcp_service_down
      condition: mcp.service_state == "not running"
      severity: critical
      message: "MCP service {service_name} is down"

    - name: delegation_agent_failed
      condition: delegation.agent_state == "failed"
      severity: warning
      message: "LaunchAgent {agent_name} failed with exit code {exit_code}"

    - name: bridge_unhealthy
      condition: bridge.http_status != 200
      severity: critical
      message: "MCP WebBridge health check failed (status: {http_status})"

    - name: bridge_slow_response
      condition: bridge.response_time_ms > 5000
      severity: warning
      message: "MCP WebBridge response time ({response_time_ms}ms) exceeds threshold"

# Aggregation settings
aggregation:
  interval_seconds: 300  # Run every 5 minutes
  retention_hours: 168   # Keep 7 days of historical data

# Export to external systems
exports:
  grafana_loki:
    enabled: true
    endpoint: http://127.0.0.1:3100/loki/api/v1/push
    batch_size: 100
    flush_interval_seconds: 60

  telegram:
    enabled: true
    summary_format: markdown
    include_graphs: false
    summary_triggers:
      - on_critical_alert
      - daily_digest

# Schema validation
schema:
  version: "2.0"
  path: ~/02luka/g/schemas/telemetry_v2.schema.json
  strict_mode: true

# Telemetry metadata
metadata:
  repository: 02luka
  component: system-telemetry-aggregator
  phase: 21.4
  tracking:
    - timestamp
    - hostname
    - git_commit
    - uptime_seconds
