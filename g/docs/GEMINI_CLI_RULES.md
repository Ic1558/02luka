# Gemini CLI Operational Rules and Safety Requirements

## 1.0 Purpose

This document defines the operational rules, safety requirements, and protocols for the `gemini-cli` agent when acting as an operational writer. These rules ensure that all actions performed by the CLI agent are safe, predictable, and adhere to the 02luka system's governance and context engineering protocols.

## 2.0 Gemini CLI Operational Rules

### 2.1 Write Mode

- **MUST** operate in a `diff-only` write mode by default. Full file overwrites are prohibited unless a valid diff is provided and approved.
- **SHOULD** generate and apply standard `unified diff` patches.

### 2.2 Pre-Write Validation

- **MUST** request explicit validation from the Boss by invoking `@g/tools/validate_launchagent_paths.zsh` before writing to any files related to `LaunchAgents`. This is a mandatory safety check to prevent system instability.

### 2.3 Sandbox Execution

- **MAY** bypass the sandbox execution environment for writes *only when* a change has been automatically approved by a routing decision engine or a pre-approved work order.
- All other writes, especially those manually initiated or modified, **SHOULD** be tested in a sandboxed environment first.

### 2.4 Zone Permissions

- **MUST NOT** write to `locked zones` (e.g., `/core/governance/**`, `/CLC/**`) without an explicit `Boss override`.
- If a task requires modification of a locked zone, the agent **MUST** generate a patch proposal for CLC or Boss to review and apply.

### 2.5 Bulk File Editing

- For tasks involving more than five (5) files, the agent **MUST** follow a multi-phase protocol:
    1.  Present a plan of all files to be changed.
    2.  Group related files into logical batches.
    3.  Request Boss approval for each batch before applying the patches.
    4.  Provide a final summary of all changes upon completion.

## 3.0 Gemini CLI Patch Safety Requirements

### 3.1 Diff Verification

- Before applying any patch, the agent **MUST** verify the `diff` to ensure it applies cleanly and does not corrupt the target file.
- The verification process **SHOULD** include a dry run if the tooling supports it.

### 3.2 File Boundary Checks

- The agent **MUST** ensure that its patches do not write outside of the intended file boundaries.
- The agent **MUST** validate file paths and reject any that use directory traversal (`../`) or resolve to outside the project's SOT.

### 3.3 Zone Validation

- At runtime, the agent **MUST** cross-reference the target file paths with the `zones.locked_zones` and `zones.allowed_zones` defined in `CONTEXT_ENGINEERING_PROTOCOL_v3.schema.json`.
- Any attempt to write to a locked zone without an override flag **MUST** be rejected.

### 3.4 Commit and MLS Logging

- All commits generated by the agent **MUST** be tagged with `producer: gemini-cli` in the commit metadata or message.
- Every SOT write **MUST** be logged to the MLS (Multi-Loop Learning System) with the following information:
    - `producer`: "gemini-cli"
    - `action`: "write_file_patch"
    - `file`: The path to the modified file.
    - `reason`: The task or work order ID.
    - `approval`: The source of approval (e.g., "Boss override", "WO-123", "Routing Engine").
    - `content_hash`: The SHA256 hash of the applied patch.

## 4.0 MLS Integration (Read-Only)

- **MUST** read `g/knowledge/mls_lessons_cli.jsonl` (if present) before building a prompt for patch work and treat the lessons as authoritative guidance, especially when touching LaunchAgents, bridge/handlers, watchers, Redis, or the filesystem.
- **MUST** surface the “MLS Recent Lessons (Read-Only)” block at the top of the system prompt (our `g/tools/mls_cli_prompt.py` helper and Gemini CLI wrapper already do this) and defer to MLS guidance whenever it conflicts with generic instincts.
- **MUST NOT** write to `g/knowledge/mls_lessons.jsonl` or other canonical MLS ledgers—CLC remains the sole writer. If Gemini CLI discovers a new actionable pattern, emit only the optional `mls_suggestion` block for human review (no automatic ledger writes).
- **SHOULD** arrange for `g/tools/mls_build_cli_feed.py` to run whenever MLS receives new entries (for example, via the MLS worker or the ledger watch) so the CLI feed stays up to date.

Optional `mls_suggestion` structure:

```yaml
mls_suggestion:
  area: "launchagents"
  severity: "medium"
  pattern: "Validate launchd paths before patching"
  example: "Use g/tools/validate_launchagent_paths.zsh after crafting the patch."
  reason: "Add validation guard for LaunchAgent updates."
```
