# Feature SPEC: AP/IO v3.1 Ledger - Verification & Enhancement

**Date:** 2025-11-16  
**Feature:** AP/IO v3.1 Ledger Verification, Ledger Extension Fields, Test Validation, Real Integration  
**Type:** Enhancement / Verification  
**Target:** Complete AP/IO v3.1 Ledger System

---

## 1. Problem Statement

Current AP/IO v3.1 Ledger implementation has gaps:
- **Ledger Extension Fields Missing:** `ledger_id`, `parent_id`, `execution_duration_ms` not in schema/docs
- **Test Validation:** Tests exist but not verified to pass on local
- **Real Integration:** Not yet integrated with actual WO/agents pipeline
- **Ledger Viewer:** No tool to view/analyze ledger entries

**Goal:** Complete AP/IO v3.1 Ledger System by:
1. Adding Ledger Extension fields to schema and docs
2. Verifying all tests pass
3. Integrating with real WO/agents workflows
4. Creating ledger viewer tool

---

## 2. Goals

1. **Ledger Extension Fields**
   - Add `ledger_id` (unique ID per ledger entry)
   - Add `parent_id` (link to parent event/WO/session)
   - Add `execution_duration_ms` (precise execution time in milliseconds)
   - Update schema and documentation

2. **Test Validation**
   - Run all test suites locally
   - Fix any failing tests
   - Ensure all tests pass (exit code 0)
   - Verify ledger writes work correctly

3. **Real Integration**
   - Integrate with Hybrid WO execution
   - Integrate with Andy Codex CLI workflows
   - Integrate with Liam orchestration decisions
   - Verify events are written to ledger

4. **Ledger Viewer**
   - Create `tools/ap_io_v31/pretty_print.zsh`
   - Support grouping by correlation_id
   - Display timeline per agent
   - Show execution duration and relationships

---

## 3. Scope

### ✅ Included

**Ledger Extension:**
- Schema updates (add ledger_id, parent_id, execution_duration_ms)
- Documentation updates (AP_IO_V31_PROTOCOL.md)
- Writer stub updates (generate ledger_id, capture execution_duration_ms)
- Reader stub updates (parse new fields)

**Test Validation:**
- Run all 5 test suites
- Fix any failures
- Document test results

**Real Integration:**
- Hybrid WO execution hooks
- Andy Codex CLI wrapper integration
- Liam orchestration event logging
- Verify end-to-end flow

**Ledger Viewer:**
- Pretty print tool
- Correlation grouping
- Timeline visualization
- Agent activity summary

### ❌ Excluded

- Web dashboard (out of scope)
- Real-time streaming (future)
- Advanced analytics (future)

---

## 4. Requirements

### 4.1 Ledger Extension Fields

**ledger_id:**
- Format: `ledger-YYYYMMDD-HHMMSS-<agent>-<seq>`
- Unique per ledger entry
- Auto-generated by writer

**parent_id:**
- Format: `parent-<type>-<id>`
- Types: `wo`, `event`, `session`
- Links to parent WO/event/session
- Optional field

**execution_duration_ms:**
- Type: number (milliseconds)
- Precise execution time
- More accurate than `duration_sec`
- Optional field (can coexist with duration_sec)

### 4.2 Schema Updates

Update `schemas/ap_io_v31_ledger.schema.json`:
```json
{
  "ledger_id": {
    "type": "string",
    "pattern": "^ledger-[0-9]{8}-[0-9]{6}-[a-z]+-[0-9]+$",
    "description": "Unique ledger entry ID"
  },
  "parent_id": {
    "type": "string",
    "pattern": "^parent-(wo|event|session)-.+$",
    "description": "Parent WO/event/session ID"
  },
  "data": {
    "properties": {
      "execution_duration_ms": {
        "type": "number",
        "minimum": 0,
        "description": "Execution duration in milliseconds"
      }
    }
  }
}
```

### 4.3 Documentation Updates

Add to `docs/AP_IO_V31_PROTOCOL.md`:
- Section: "Ledger Extension Fields"
- Explain ledger_id, parent_id, execution_duration_ms
- Provide examples
- Link to schema

### 4.4 Test Validation

**Test Suites to Run:**
1. `tests/ap_io_v31/cls_testcases.zsh` (12 tests)
2. `tests/ap_io_v31/test_protocol_validation.zsh`
3. `tests/ap_io_v31/test_routing.zsh`
4. `tests/ap_io_v31/test_correlation.zsh`
5. `tests/ap_io_v31/test_backward_compat.zsh`

**Success Criteria:**
- All tests pass (exit code 0)
- No errors in output
- Ledger files created correctly
- Schema validation passes

### 4.5 Real Integration

**Hybrid WO Execution:**
- Hook into WO execution scripts
- Write `task_start` when WO begins
- Write `task_result` when WO completes
- Include `execution_duration_ms`
- Link via `parent_id` to WO ID

**Andy Codex CLI:**
- Wrap Codex CLI execution
- Capture start/end timestamps
- Calculate `execution_duration_ms`
- Write events to ledger
- Link via `parent_id` to task ID

**Liam Orchestration:**
- Log orchestration decisions
- Create correlation_id for multi-agent tasks
- Write routing events
- Track agent coordination

### 4.6 Ledger Viewer

**Features:**
- Pretty print ledger entries
- Group by correlation_id
- Show timeline per agent
- Display execution duration
- Show parent-child relationships
- Filter by agent/event type/date

**Usage:**
```bash
tools/ap_io_v31/pretty_print.zsh g/ledger/cls/2025-11-16.jsonl
tools/ap_io_v31/pretty_print.zsh g/ledger/cls/2025-11-16.jsonl --group-by correlation
tools/ap_io_v31/pretty_print.zsh g/ledger/cls/2025-11-16.jsonl --filter agent=cls --filter event=task_result
```

---

## 5. Success Criteria

1. ✅ Ledger Extension fields added to schema
2. ✅ Documentation updated with Ledger Extension section
3. ✅ All 5 test suites pass locally
4. ✅ Hybrid WO execution writes to ledger
5. ✅ Andy Codex CLI writes to ledger
6. ✅ Liam orchestration writes to ledger
7. ✅ Ledger viewer tool created and working
8. ✅ End-to-end flow verified

---

## 6. Dependencies

- Existing AP/IO v3.1 infrastructure
- Agent integrations (CLS, Andy, Hybrid, Liam)
- WO execution system
- Codex CLI

---

**Spec Owner:** Liam  
**Implementer:** Andy (primary) + CLS (validation)  
**Verifier:** CLS
