#!/usr/bin/env zsh
# Quality gate run by CLS/CLC "stop hook" (soft-fail policy)
# Ensures deployments include health/docs/rollback artifacts.
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
cd "$PROJECT_ROOT"

# Accept type via env or arg, default to "generic"
TYPE="${TYPE:-${1:-generic}}"

echo "== Quality Gate (type=$TYPE, soft-fail) =="

warns=0
require_file() {
  local path="$1" label="$2"
  if [[ ! -f "$path" ]]; then
    echo "⚠️  Missing ${label}: $path"
    warns=$((warns+1))
  else
    echo "✅ Found ${label}: $path"
  fi
}

if [[ "$TYPE" == "deploy" ]]; then
  # Heuristics for current deployment target
  DEP_NAME="${DEPLOY_NAME:-$(git rev-parse --abbrev-ref HEAD)}"
  # Flexible locations/patterns used in 02luka
  require_file "tools/${DEP_NAME}_health_check.zsh" "health check"
  require_file "g/reports/DEPLOYMENT_PLAN_${DEP_NAME}.md" "deployment plan"
  # Rollback can be generated with our tool generator
  # accept any rollback_*.zsh in tools/
  if [[ -n "$(find tools -maxdepth 1 -name 'rollback_*.zsh' 2>/dev/null | head -1)" ]]; then
    echo "✅ Rollback script present"
  else
    echo "⚠️  Missing rollback script (tools/rollback_*.zsh)"
    warns=$((warns+1))
  fi
  # Basic docs presence
  if [[ -f "README.md" ]] || [[ -d docs ]]; then
    echo "✅ Documentation present (README/docs)"
  else
    echo "⚠️  Missing documentation (README or docs/)"
    warns=$((warns+1))
  fi
else
  echo "ℹ️  Non-deploy task: no mandatory checks"
fi

if (( warns > 0 )); then
  echo "\n⚠️  Quality gate raised ${warns} warning(s). Not blocking (soft-fail)."
else
  echo "\n✅ Quality gate checks passed."
fi

exit 0
