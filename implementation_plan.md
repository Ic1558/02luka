# Implementation Plan — Shared Core History for All Agents

## Objective (risk-first)
Ship a standalone, deterministic core-history generator (zsh) that any agent can call (Codex CLI/IDE, Gemini CLI, cron/LaunchAgent) without depending on Antigravity or Raycast. Only after core is stable do we wire adapters (e.g., Raycast hotkeys). Avoid UX regression in existing Raycast scripts.

## Scope / Constraints
- Do first: `tools/core_history_sync.zsh` (single entrypoint, SIP-friendly, rollbackable).
- Do later: Raycast integration (call the tool, not vice versa) once core is proven.
- Inputs must be best-effort; no failures if Antigravity is down. Atomic writes only.

## Current Signals (as of now)
- Decision telemetry: `g/telemetry/decision_log.jsonl` (decision_summarizer via gemini_bridge).
- Snapshots: `magic_bridge/inbox/atg_snapshot.md` (+ `.summary.txt` if Gemini ran).
- Ops/bridge logs: `/tmp/com.antigravity.bridge.*.log`, `g/telemetry/atg_runner.jsonl`, `g/telemetry/fs_index.jsonl`.
- Task logging: `g/reports/codex_routing_log.jsonl`, `g/knowledge/tasks.jsonl`.

## Target Outputs (stable paths)
- Machine-readable: `g/telemetry/core_history/latest.json`
- Human-readable: `g/telemetry/core_history/latest.md`
- Generated by `tools/core_history_sync.zsh --run`; safe preview via `--dry-run`.

## Tool Design: `tools/core_history_sync.zsh`
- Flags: `--dry-run` (stdout only), `--run` (atomic write), `--out-dir <dir>` (default `g/telemetry/core_history`), `--max-decisions N` (default 40), `--max-ops N` (default 40).
- Behavior:
  - Gather latest snapshot from `magic_bridge/inbox/atg_snapshot.md` + optional `.summary.txt` (if absent, mark “snapshot_missing”).
  - Tail recent decisions from `g/telemetry/decision_log.jsonl` (include ts, risk, route_hint, text_preview).
  - Tail recent ops pulses from `g/telemetry/atg_runner.jsonl` and `g/telemetry/fs_index.jsonl` when present.
  - Include git context from snapshot if present; otherwise minimal `git status`/`head` lightweight call.
  - Embed decision rule table hash (read from `decision_summarizer.py`, hash of RULE_TABLE block) and record source path/version.
  - Emit JSON structure with sections: `meta` (ts, generator_version, host), `snapshot`, `decisions`, `ops`, `tasks` (optional tail of `codex_routing_log.jsonl`), `sources`.
  - Emit MD summary with the same content in compact sections for copy/paste.
  - Atomic write: mktemp → write → mv to `latest.json`/`latest.md`.
- Failure model: never crash; missing inputs become `{status: "missing"}` entries.

## Rollout Steps
1) Implement `tools/core_history_sync.zsh` with `--dry-run/--run`, atomic writes, and integrity hash for RULE_TABLE.
2) Add minimal doc/readme snippet (usage + expected outputs) and note in `agents/liam/task.md` once shipped.
3) (Later) Wire Raycast `atg-snapshot*.command` to optionally call `tools/core_history_sync.zsh --run` after snapshot (or drop a trigger file).
4) (Later) Add a cron/LaunchAgent or `make core-history` alias for periodic refresh.

## Verify / DRY-RUN plan
- Run `tools/core_history_sync.zsh --dry-run` (no writes) and capture output.
- Run `tools/core_history_sync.zsh --run` and check:
  - Files exist: `g/telemetry/core_history/latest.json`, `latest.md`.
  - JSON validates (jq), MD contains sections and counts.
  - RULE_TABLE hash matches `decision_summarizer.py`.
- Optional: unit-ish check via `python -c 'import json,sys;json.load(open("g/telemetry/core_history/latest.json"))'`.

## Decisions/Approvals needed
- Confirm tool path/name: `tools/core_history_sync.zsh`.
- Confirm output dir: `g/telemetry/core_history/`.
- Confirm default tails: decisions=40, ops=40 (adjust as needed).
- Confirm we defer Raycast integration until core tool is verified.
