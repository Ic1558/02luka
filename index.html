<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Luka</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --border: #262626;
      --text: #fafafa;
      --text-muted: #a3a3a3;
      --accent: #3b82f6;
      --success: #22c55e;
      --warning: #eab308;
      --error: #ef4444;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Text', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Header - Ultra Minimal */
    header {
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .logo {
      width: 24px;
      height: 24px;
      background: var(--accent);
      border-radius: 6px;
      display: grid;
      place-items: center;
      font-weight: 700;
      font-size: 12px;
    }

    .status {
      flex: 1;
      font-size: 12px;
      color: var(--text-muted);
    }

    .gateway {
      padding: 4px 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text);
      cursor: pointer;
      outline: none;
    }

    .gateway:hover {
      border-color: var(--text-muted);
    }

    /* Main Layout */
    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar - Collapsed by Default */
    aside {
      width: 0;
      overflow: hidden;
      border-right: 1px solid var(--border);
      transition: width 0.2s ease;
    }

    aside.open {
      width: 280px;
    }

    .sidebar-content {
      padding: 16px;
      width: 280px;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 12px;
    }

    .metric-label {
      color: var(--text-muted);
    }

    .metric-value {
      font-family: 'SF Mono', 'Monaco', monospace;
    }

    .online { color: var(--success); }
    .partial { color: var(--warning); }
    .offline { color: var(--error); }

    /* Chat Area */
    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Messages */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .messages::-webkit-scrollbar {
      width: 6px;
    }

    .messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .message {
      display: flex;
      gap: 12px;
      max-width: 720px;
      width: 100%;
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--surface);
      display: grid;
      place-items: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: var(--accent);
    }

    .message-content {
      background: var(--surface);
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 100%;
    }

    .message.user .message-content {
      background: var(--accent);
    }

    .message-content pre {
      background: rgba(0,0,0,0.3);
      padding: 8px;
      border-radius: 6px;
      margin-top: 8px;
      overflow-x: auto;
      font-size: 12px;
    }

    .message-content code {
      background: rgba(0,0,0,0.2);
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 12px;
    }

    /* Input Area */
    .input-area {
      padding: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .input-wrapper {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
    }

    .input-wrapper:focus-within {
      border-color: var(--accent);
    }

    .input-wrapper.drag-over {
      border-color: var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }

    .input-controls {
      display: flex;
      align-items: flex-end;
      gap: 12px;
    }

    /* File Upload */
    .file-input {
      display: none;
    }

    .upload-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: all 0.2s;
    }

    .upload-btn:hover {
      background: var(--surface);
      color: var(--text);
      border-color: var(--accent);
    }

    /* File Preview */
    .file-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
      max-width: 200px;
    }

    .file-item img {
      width: 24px;
      height: 24px;
      object-fit: cover;
      border-radius: 4px;
    }

    .file-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-remove {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0;
      width: 16px;
      height: 16px;
      display: grid;
      place-items: center;
    }

    .file-remove:hover {
      color: var(--error);
    }

    /* Drag & Drop Overlay */
    .drop-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(59, 130, 246, 0.1);
      border: 2px dashed var(--accent);
      border-radius: 12px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--accent);
      z-index: 10;
    }

    .drop-overlay.active {
      display: flex;
    }

    #input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      min-height: 20px;
      max-height: 120px;
    }

    #input::placeholder {
      color: var(--text-muted);
    }

    .send-btn {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      display: grid;
      place-items: center;
      flex-shrink: 0;
      transition: opacity 0.2s;
    }

    .send-btn:hover {
      opacity: 0.9;
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Keyboard Shortcut */
    .shortcut {
      font-size: 11px;
      color: var(--text-muted);
      padding: 2px 4px;
      background: var(--surface);
      border-radius: 3px;
      font-family: 'SF Mono', monospace;
    }

    /* Toggle Button */
    .toggle {
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      display: grid;
      place-items: center;
    }

    .toggle:hover {
      background: var(--surface);
      color: var(--text);
    }

    /* Responsive */
    @media (max-width: 640px) {
      aside.open {
        position: absolute;
        z-index: 100;
        background: var(--bg);
        height: 100%;
        box-shadow: 4px 0 24px rgba(0,0,0,0.5);
      }

      .message {
        max-width: 100%;
      }
    }

    /* Loading Dots */
    .typing {
      display: inline-flex;
      gap: 4px;
    }

    .typing span {
      width: 8px;
      height: 8px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: pulse 1.4s infinite;
    }

    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes pulse {
      0%, 60%, 100% { opacity: 0.3; }
      30% { opacity: 1; }
    }
  </style>
</head>
<body>
  <header>
    <button class="toggle" onclick="toggleSidebar()" title="Toggle sidebar (‚åòK)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 12h18M3 6h18M3 18h18"/>
      </svg>
    </button>
    <div class="logo">L</div>
    <div class="status">
      <span id="status">Connected</span> ‚Ä¢ <span id="latency">12ms</span>
    </div>
    <select class="gateway" id="gateway">
      <option value="auto">üîÆ Auto-Select</option>
      <optgroup label="Core Systems">
        <option value="gc_core">üß† GC Core</option>
        <option value="gg_core">‚ö° GG Core</option>
        <option value="mcp_gateway">üê≥ MCP Gateway</option>
        <option value="npu">üßÆ NPU Core</option>
      </optgroup>
      <optgroup label="Agents">
        <option value="mary">üë© Mary Agent</option>
        <option value="paula">ü§ñ Paula Agent</option>
        <option value="qs">‚ùì QS Agent</option>
        <option value="sumo">ü•ã Sumo Agent</option>
        <option value="lisa">üìä Lisa Agent</option>
        <option value="kim">ü§ñ Kim Bot Agent</option>
      </optgroup>
      <optgroup label="External">
        <option value="ollama">ü¶ô Ollama LLM</option>
        <option value="edge">‚òÅÔ∏è Edge Worker</option>
      </optgroup>
    </select>
  </header>

  <main>
    <aside id="sidebar">
      <div class="sidebar-content">
        <div class="metric">
          <span class="metric-label">Docker</span>
          <span class="metric-value online">‚óè 15</span>
        </div>
        <div class="metric">
          <span class="metric-label">MCP</span>
          <span class="metric-value online">‚óè Active</span>
        </div>
        <div class="metric">
          <span class="metric-label">Agents</span>
          <span class="metric-value partial">‚óè 78%</span>
        </div>
        <div class="metric">
          <span class="metric-label">Memory</span>
          <span class="metric-value">2.1 GB</span>
        </div>
        <div class="metric">
          <span class="metric-label">Uptime</span>
          <span class="metric-value">47h 23m</span>
        </div>
      </div>
    </aside>

    <div class="chat">
      <div class="messages" id="messages">
        <div class="message">
          <div class="message-avatar">L</div>
          <div class="message-content">
            Ready. 02luka system operational.
          </div>
        </div>
      </div>

      <div class="input-area">
        <div class="input-wrapper" id="inputWrapper">
          <div class="drop-overlay" id="dropOverlay">
            üìÅ Drop files here to upload
          </div>

          <div class="file-preview" id="filePreview"></div>

          <div class="input-controls">
            <textarea id="input" placeholder="Message Luka..." rows="1"></textarea>
            <span class="shortcut">‚åò‚Üµ</span>

            <input type="file" id="fileInput" class="file-input" multiple
                   accept="image/*,text/*,.pdf,.doc,.docx,.txt,.md,.json,.csv">

            <button class="upload-btn" onclick="document.getElementById('fileInput').click()"
                    title="Upload files (images, documents, etc.)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
              </svg>
            </button>

            <button class="send-btn" id="send" onclick="sendMessage()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // 02luka Agent State
    const state = {
      gateway: localStorage.getItem('luka.gateway') || 'auto',
      messages: [],
      attachedFiles: [],
      gateways: {
        auto: { url: 'http://127.0.0.1:5012', name: 'üîÆ Auto-Select', type: 'mcp' },

        // Core Systems
        gc_core: { url: 'http://127.0.0.1:5009', name: 'üß† GC Core', type: 'agent' },
        gg_core: { url: 'http://127.0.0.1:5010', name: '‚ö° GG Core', type: 'agent' },
        mcp_gateway: { url: 'http://127.0.0.1:5012', name: 'üê≥ MCP Gateway', type: 'mcp' },

        // Individual Agents
        mary: { url: 'http://127.0.0.1:5001', name: 'üë© Mary Agent', type: 'agent' },
        paula: { url: 'http://127.0.0.1:5002', name: 'ü§ñ Paula Agent', type: 'agent' },
        qs: { url: 'http://127.0.0.1:5004', name: '‚ùì QS Agent', type: 'agent' },
        sumo: { url: 'http://127.0.0.1:5006', name: 'ü•ã Sumo Agent', type: 'agent' },
        lisa: { url: 'http://127.0.0.1:5007', name: 'üìä Lisa Agent', type: 'agent' },
        kim: { url: 'http://127.0.0.1:5011', name: 'ü§ñ Kim Bot Agent', type: 'agent' },

        // External
        ollama: { url: 'http://localhost:11434/v1/chat/completions', name: 'ü¶ô Ollama LLM', type: 'ollama' },
        edge: { url: 'https://idx-02luka.workers.dev', name: '‚òÅÔ∏è Edge Worker', type: 'edge' },
        npu: { url: 'http://127.0.0.1:7000', name: 'üßÆ NPU Core', type: 'npu' }
      }
    };

    // Toggle sidebar
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // File Handling Functions
    function handleFiles(files) {
      Array.from(files).forEach(file => {
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
          alert(`File "${file.name}" is too large. Max size: 10MB`);
          return;
        }

        const fileObj = {
          id: crypto.randomUUID(),
          file: file,
          name: file.name,
          type: file.type,
          size: file.size,
          data: null
        };

        // Read file as base64 for sending
        const reader = new FileReader();
        reader.onload = (e) => {
          fileObj.data = e.target.result;
          state.attachedFiles.push(fileObj);
          updateFilePreview();
        };
        reader.readAsDataURL(file);
      });
    }

    function removeFile(fileId) {
      state.attachedFiles = state.attachedFiles.filter(f => f.id !== fileId);
      updateFilePreview();
    }

    function updateFilePreview() {
      const preview = document.getElementById('filePreview');
      if (state.attachedFiles.length === 0) {
        preview.innerHTML = '';
        return;
      }

      preview.innerHTML = state.attachedFiles.map(file => `
        <div class="file-item">
          ${file.type.startsWith('image/') ?
            `<img src="${file.data}" alt="${file.name}">` :
            `<span>üìÑ</span>`
          }
          <span class="file-name" title="${file.name}">${file.name}</span>
          <button class="file-remove" onclick="removeFile('${file.id}')" title="Remove">√ó</button>
        </div>
      `).join('');
    }

    // Drag & Drop Implementation
    function setupDragAndDrop() {
      const wrapper = document.getElementById('inputWrapper');
      const overlay = document.getElementById('dropOverlay');
      let dragCounter = 0;

      wrapper.addEventListener('dragenter', (e) => {
        e.preventDefault();
        dragCounter++;
        wrapper.classList.add('drag-over');
        overlay.classList.add('active');
      });

      wrapper.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dragCounter--;
        if (dragCounter === 0) {
          wrapper.classList.remove('drag-over');
          overlay.classList.remove('active');
        }
      });

      wrapper.addEventListener('dragover', (e) => {
        e.preventDefault();
      });

      wrapper.addEventListener('drop', (e) => {
        e.preventDefault();
        dragCounter = 0;
        wrapper.classList.remove('drag-over');
        overlay.classList.remove('active');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFiles(files);
        }
      });
    }

    // File Input Handler
    function setupFileInput() {
      document.getElementById('fileInput').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFiles(e.target.files);
          e.target.value = ''; // Reset input
        }
      });
    }

    // Auto-resize textarea
    const input = document.getElementById('input');
    input.addEventListener('input', () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    });

    // Send message
    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      // Add user message
      addMessage('user', text);
      input.value = '';
      input.style.height = 'auto';

      // Show typing
      const typingId = showTyping();

      try {
        const gateway = state.gateways[state.gateway];
        const start = Date.now();

        let response;

        if (gateway.type === 'ollama') {
          // Ollama API
          const res = await fetch(gateway.url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model: 'llama2',
              messages: [
                { role: 'system', content: `You are ${gateway.name} in the 02luka system. Be concise and helpful.` },
                ...state.messages
              ]
            })
          });
          const data = await res.json();
          response = data.choices?.[0]?.message?.content || 'No response';

        } else if (gateway.type === 'agent') {
          // Direct agent communication - try multiple endpoint patterns
          const payload = {
            message: text,
            prompt: text,
            input: text,
            query: text,
            context: '02luka system',
            agent: gateway.name
          };

          // Add files if any
          if (state.attachedFiles.length > 0) {
            payload.files = state.attachedFiles.map(f => ({
              name: f.name,
              type: f.type,
              size: f.size,
              data: f.data
            }));
          }

          // Try different endpoints
          const endpoints = ['/chat', '/api/chat', '/message', '/query', '/'];
          let res = null;
          let lastError = null;

          for (const endpoint of endpoints) {
            try {
              res = await fetch(gateway.url + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                signal: AbortSignal.timeout(5000)
              });
              if (res.ok) break;
            } catch (err) {
              lastError = err;
              continue;
            }
          }

          if (!res || !res.ok) {
            throw new Error(`Agent ${gateway.name} not responding on any endpoint`);
          }

          const data = await res.json();
          response = data.response || data.reply || data.message || data.output || `Connected to ${gateway.name}. Endpoint working.`;

        } else if (gateway.type === 'npu') {
          // NPU Core communication
          const res = await fetch(gateway.url + '/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              input: text,
              mode: 'chat',
              optimize: true
            })
          });
          const data = await res.json();
          response = data.output || data.result || 'NPU processing complete';

        } else if (gateway.type === 'mcp') {
          // MCP Gateway - first check health, then try different endpoints
          const healthRes = await fetch(gateway.url + '/health');
          if (!healthRes.ok) {
            throw new Error('MCP Gateway not available');
          }

          const payload = {
            messages: [...state.messages, { role: 'user', content: text }],
            system: `You are ${gateway.name}. Access to 02luka tools and Docker containers.`,
            tools: ['filesystem', 'docker', 'system']
          };

          // Add files if any
          if (state.attachedFiles.length > 0) {
            payload.files = state.attachedFiles.map(f => ({
              name: f.name,
              type: f.type,
              size: f.size,
              data: f.data
            }));
            payload.tools.push('image_analysis', 'file_processing');
          }

          // Try MCP endpoints
          const endpoints = ['/chat', '/api/chat', '/v1/chat/completions'];
          let res = null;

          for (const endpoint of endpoints) {
            try {
              res = await fetch(gateway.url + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                signal: AbortSignal.timeout(10000)
              });
              if (res.ok) break;
            } catch (err) {
              continue;
            }
          }

          if (!res || !res.ok) {
            // Fallback: just return health status
            response = `MCP Gateway is healthy but chat endpoints not configured. Status: ${JSON.stringify(await healthRes.json())}`;
          } else {
            const data = await res.json();
            response = data.reply || data.output || data.message || data.choices?.[0]?.message?.content || JSON.stringify(data);
          }

        } else {
          // Generic/Edge worker
          const res = await fetch(gateway.url + '/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: state.messages,
              system: `You are ${gateway.name} in the 02luka system.`
            })
          });
          const data = await res.json();
          response = data.reply || data.output || JSON.stringify(data);
        }

        // Update latency
        document.getElementById('latency').textContent = `${Date.now() - start}ms`;

        // Remove typing and add response
        removeTyping(typingId);
        addMessage('assistant', response);

        // Clear attached files after successful send
        state.attachedFiles = [];
        updateFilePreview();

      } catch (err) {
        removeTyping(typingId);
        addMessage('assistant', `Error: ${err.message}`);
        document.getElementById('status').textContent = 'Disconnected';
      }
    }

    // Add message to UI
    function addMessage(role, content) {
      state.messages.push({ role, content });

      const messagesEl = document.getElementById('messages');
      const msgEl = document.createElement('div');
      msgEl.className = `message ${role}`;

      msgEl.innerHTML = `
        <div class="message-avatar">${role === 'user' ? 'U' : 'L'}</div>
        <div class="message-content">${formatContent(content)}</div>
      `;

      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Format content
    function formatContent(text) {
      return text
        .replace(/```([\s\S]*?)```/g, '<pre>$1</pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');
    }

    // Show typing indicator
    function showTyping() {
      const id = 'typing-' + Date.now();
      const messagesEl = document.getElementById('messages');
      const msgEl = document.createElement('div');
      msgEl.id = id;
      msgEl.className = 'message';
      msgEl.innerHTML = `
        <div class="message-avatar">L</div>
        <div class="message-content">
          <div class="typing">
            <span></span><span></span><span></span>
          </div>
        </div>
      `;
      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return id;
    }

    // Remove typing indicator
    function removeTyping(id) {
      document.getElementById(id)?.remove();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        toggleSidebar();
      }
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Gateway change
    document.getElementById('gateway').addEventListener('change', (e) => {
      state.gateway = e.target.value;
      localStorage.setItem('luka.gateway', state.gateway);
    });

    // Initialize
    document.getElementById('gateway').value = state.gateway;

    // Setup file handling
    setupDragAndDrop();
    setupFileInput();

    // Focus input on load
    input.focus();
  
/* --- NLU (browser-only) --- */
function nluExtract(text){
  const doc = (window.nlp||{people:()=>({out:()=>[]}),places:()=>({out:()=>[]}),organizations:()=>({out:()=>[]}),numbers:()=>({out:()=>[]}),dates:()=>({out:()=>[]}),dates:()=>({out:()=>[],json:()=>[]})}).call? window.nlp(text) : {people:()=>({out:()=>[]}),places:()=>({out:()=>[]}),organizations:()=>({out:()=>[]}),numbers:()=>({out:()=>[]}),dates:()=>({out:()=>[],json:()=>[]})};
  const ents=[]; 
  try{
    (doc.people?.().out("array")||[]).forEach(x=>ents.push({type:"person",value:x}));
    (doc.places?.().out("array")||[]).forEach(x=>ents.push({type:"place",value:x}));
    (doc.organizations?.().out("array")||[]).forEach(x=>ents.push({type:"org",value:x}));
    (doc.numbers?.().out("array")||[]).forEach(x=>ents.push({type:"number",value:x}));
    (doc.dates?.().out("array")||[]).forEach(x=>ents.push({type:"date",value:x}));
  }catch(_){}
  const lower = (text||"").toLowerCase();
  const intents=[];
  if (/(open|‡πÄ‡∏õ‡∏¥‡∏î).*(http|www.|.com|.io|.dev)/.test(lower)) intents.push({name:"open_url"});
  if (/(search|‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤|‡∏´‡∏≤)/.test(lower)) intents.push({name:"search"});
  if (/(schedule|‡∏ô‡∏±‡∏î|‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô|remind|calendar)/.test(lower)) intents.push({name:"schedule"});
  if (/(status|health|tools|mcp)/.test(lower)) intents.push({name:"check_status"});
  if (/(file|‡πÑ‡∏ü‡∏•‡πå|copy|move|‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô|‡∏•‡∏ö)/.test(lower)) intents.push({name:"file_op"});
  const urls=(text.match(/https?://S+/g)||[]).map(u=>({type:"url",value:u}));
  let dates=[];
  try{dates = (doc.dates?.().json()||[]).map(d=>({type:"date_norm",value:d.text,iso:(d.date&&d.date.start)||null}))}catch(_){}
  const slots=[...urls,...dates];
  return {intents,entities:ents,slots,text};
}
</script>
  <script id="luka-ui-send-helper">
(function(){
  // Grab best-guess elements Luka uses
  var input = document.querySelector("main textarea, main input[type=text]");
  var sendBtn = document.querySelector("main button[type=submit], main button[data-role=send-btn], button[type=submit]");

  if (!input || !sendBtn) return;

  function syncState(){
    var has = (input.value || "").trim().length > 0;
    sendBtn.disabled = !has;
    sendBtn.setAttribute("aria-disabled", String(!has));
  }

  // Keep state in sync
  input.addEventListener("input",  syncState);
  input.addEventListener("change", syncState);

  // Enter to send (newline with Shift+Enter)
  input.addEventListener("keydown", function(e){
    if (e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      if (!sendBtn.disabled) sendBtn.click();
    }
  });

  // Click to send (prevent blanks)
  sendBtn.addEventListener("click", function(e){
    e.preventDefault();
    if (sendBtn.disabled) return;
    if (typeof send === "function") send();
  });

  // Initial state
  syncState();
})();
  </script>
  <script id="luka-ui-send-helper2">
(function(){
  const TAG = "[Luka-UI]";
  function log(){ try{ console.log(TAG, ...arguments); }catch(_){} }

  const selectors = {
    input: [
      "main textarea",
      "textarea",
      "main input[type=text]",
      "input[type=text]",
      "input[role=textbox]",
      "[contenteditable=true]"
    ],
    send: [
      "main button[type=submit]",
      "button[type=submit]",
      "main button[data-role=send-btn]",
      "button[data-role=send-btn]",
      "button[aria-label=Send]",
      "button[title=Send]",
      "form button:not([disabled])"
    ]
  };

  function qSel(list){
    for (const sel of list){
      const el = document.querySelector(sel);
      if (el) return el;
    }
    return null;
  }

  function setup(){
    const input  = qSel(selectors.input);
    const sendBtn= qSel(selectors.send);

    if (!input || !sendBtn){
      log("waiting‚Ä¶ input:", !!input, "send:", !!sendBtn);
      return false;
    }

    log("hooked input:", input.tagName, "send:", sendBtn.tagName);

    function hasText(){
      if ("value" in input) return (input.value||"").trim().length>0;
      if (input.isContentEditable) return (input.textContent||"").trim().length>0;
      return false;
    }

    function syncState(){
      const enable = hasText();
      sendBtn.disabled = !enable;
      sendBtn.setAttribute("aria-disabled", String(!enable));
    }

    // Keep state in sync
    (["input","change","keyup"]).forEach(ev => input.addEventListener(ev, syncState));
    // Enter to send (newline with Shift+Enter)
    input.addEventListener("keydown", e=>{
      if (e.key === "Enter" && !e.shiftKey){
        if (hasText()){
          // do NOT stop propagation unless we are sending
          e.preventDefault();
          sendBtn.click();
        }
      }
    });

    // Guard blank clicks (don‚Äôt block your existing click handler)
    sendBtn.addEventListener("click", e=>{
      if (!hasText()){
        e.preventDefault();
        e.stopImmediatePropagation();
        log("blocked blank send");
      }
    }, true); // capture so we gate prior to app handler

    // Also guard form submit if any
    const form = sendBtn.closest("form");
    if (form){
      form.addEventListener("submit", e=>{
        if (!hasText()){
          e.preventDefault();
          log("blocked blank form submit");
        }
      }, true);
    }

    // Initial state
    syncState();
    return true;
  }

  function startWhenReady(){
    if (setup()) return;
    const obs = new MutationObserver(()=>{
      if (setup()){ obs.disconnect(); }
    });
    obs.observe(document.documentElement, {childList:true, subtree:true});
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", startWhenReady);
  } else {
    startWhenReady();
  }
})();
  </script>
<script id="luka-ui-send-helper3">
(function(){
  const TAG="[Luka-UI]";
  const inputSels=["main textarea","textarea","main input[type=text]","input[type=text]","[contenteditable=true]"];
  const btnSels=["main button[type=submit]","button[type=submit]","button[data-role=send-btn]","button[aria-label=\"Send\"]","button[title=\"Send\"]"];

  const pick=(list)=>{for(const s of list){const el=document.querySelector(s);if(el) return el;}return null;};

  function hasText(inp){
    if(!inp) return false;
    if("value" in inp) return (inp.value||"").trim().length>0;
    if(inp.isContentEditable) return (inp.textContent||"").trim().length>0;
    return false;
  }

  function setup(){
    const input=pick(inputSels);
    const btn=pick(btnSels);
    if(!input||!btn){ console.log(TAG,"waiting‚Ä¶ input:",!!input,"send:",!!btn); return false; }

    console.log(TAG,"hooked", input.tagName, "‚Üí", btn.tagName);

    const sync=()=>{ const ok=hasText(input); btn.disabled=!ok; btn.setAttribute("aria-disabled", String(!ok)); };
    ["input","change","keyup"].forEach(ev=>input.addEventListener(ev, sync));
    input.addEventListener("keydown",e=>{ if(e.key==="Enter"&&!e.shiftKey&&hasText(input)){ e.preventDefault(); btn.click(); }});
    btn.addEventListener("click",e=>{ if(!hasText(input)){ e.preventDefault(); e.stopImmediatePropagation(); console.log(TAG,"blocked blank send"); }}, true);

    const form=btn.closest("form");
    if(form){ form.addEventListener("submit", e=>{ if(!hasText(input)){ e.preventDefault(); }}, true); }

    sync();
    return true;
  }

  function whenReady(){ if(setup()) return;
    const o=new MutationObserver(()=>{ if(setup()) o.disconnect(); });
    o.observe(document.documentElement,{childList:true,subtree:true});
  }

  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", whenReady);
  else whenReady();
})();
</script><!-- UI SEND HELPER START -->
<script>
(()=>{try{
  const selIn = "main textarea, main input[type=\"text\"]";
  const selBtn = "main button[type=\"submit\"], main [data-role=\"send-btn\"], button[aria-label*=\"Send\"]";
  const input = document.querySelector(selIn);
  const sendBtn = document.querySelector(selBtn);
  if(!input||!sendBtn){ console.warn("Send helper: missing nodes", {input:!!input, sendBtn:!!sendBtn}); return; }
  function sync(){
    const has = !!input.value?.trim();
    sendBtn.disabled = !has;
    sendBtn.setAttribute("aria-disabled", String(!has));
    sendBtn.style.pointerEvents = has ? "auto" : "none";
    sendBtn.classList?.remove?.("cursor-not-allowed","opacity-50");
  }
  ["input","change","keyup"].forEach(e=>input.addEventListener(e, sync));
  input.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); if(!sendBtn.disabled) sendBtn.click(); }
  });
  // one-time force
  sendBtn.removeAttribute("disabled");
  sendBtn.setAttribute("aria-disabled","false");
  sendBtn.style.pointerEvents = "auto";
  sync();
  console.log("Send helper ready");
}catch(e){console.error("Send helper error", e);}})();
</script>
<!-- UI SEND HELPER END -->
</body>
<script>(()=>{const i=document.getElementById("q"),b=document.getElementById("send"),f=b&&b.closest("form");if(!i||!b)return;const s=()=>{b.disabled=!i.value.trim()};i.addEventListener("input",s);s();if(f)f.addEventListener("submit",e=>e.preventDefault())})();</script>
</html>
