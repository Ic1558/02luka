<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>02luka System Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #1a202c;
      font-size: 32px;
      margin-bottom: 8px;
    }

    .header .subtitle {
      color: #718096;
      font-size: 14px;
    }

    .status-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .stat-card {
      flex: 1;
      min-width: 200px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-card .label {
      color: #718096;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #1a202c;
    }

    .stat-card.success .value { color: #48bb78; }
    .stat-card.warning .value { color: #ed8936; }
    .stat-card.error .value { color: #f56565; }
    .stat-card.info .value { color: #4299e1; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .panel h2 {
      color: #1a202c;
      font-size: 20px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
    }

    .service-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .service-item {
      display: flex;
      align-items: center;
      padding: 12px;
      margin-bottom: 8px;
      background: #f7fafc;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .service-item:hover {
      background: #edf2f7;
      transform: translateX(4px);
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .status-dot.running { background: #48bb78; animation: pulse 2s infinite; }
    .status-dot.stopped { background: #cbd5e0; }
    .status-dot.error { background: #f56565; }
    .status-dot.ondemand { background: #4299e1; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .service-name {
      flex: 1;
      font-weight: 500;
      color: #2d3748;
      font-size: 14px;
    }

    .service-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: #718096;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.running { background: #c6f6d5; color: #22543d; }
    .badge.stopped { background: #e2e8f0; color: #4a5568; }
    .badge.ondemand { background: #bee3f8; color: #2c5282; }

    .log-viewer {
      background: #1a202c;
      border-radius: 8px;
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 12px;
      color: #48bb78;
      line-height: 1.6;
    }

    .log-line {
      margin-bottom: 4px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .log-line.error { color: #fc8181; }
    .log-line.warn { color: #f6ad55; }
    .log-line.info { color: #63b3ed; }

    .refresh-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 16px 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .refresh-info {
      color: #718096;
      font-size: 14px;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    button:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .progress-bar {
      background: #e2e8f0;
      border-radius: 8px;
      height: 8px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      transition: width 0.3s ease;
    }

    .activity-feed {
      max-height: 200px;
      overflow-y: auto;
    }

    .activity-item {
      padding: 8px 12px;
      margin-bottom: 8px;
      background: #f7fafc;
      border-left: 3px solid #4299e1;
      border-radius: 4px;
      font-size: 13px;
    }

    .activity-item .time {
      color: #a0aec0;
      font-size: 11px;
      margin-right: 8px;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ðŸš€ 02luka System Dashboard</h1>
      <div class="subtitle">Real-time monitoring of all local agents and services</div>
    </div>

    <!-- Refresh Bar -->
    <div class="refresh-bar">
      <div class="refresh-info">
        <span id="last-update">Last updated: Loading...</span>
        <span style="margin: 0 12px;">â€¢</span>
        <span id="auto-refresh">Auto-refresh: ON (30s)</span>
      </div>
      <button onclick="refreshData()">ðŸ”„ Refresh Now</button>
    </div>

    <!-- Status Cards -->
    <div class="status-bar">
      <div class="stat-card success">
        <div class="label">Running Services</div>
        <div class="value" id="running-count">-</div>
      </div>
      <div class="stat-card info">
        <div class="label">OnDemand Services</div>
        <div class="value" id="ondemand-count">-</div>
      </div>
      <div class="stat-card warning">
        <div class="label">Stopped Services</div>
        <div class="value" id="stopped-count">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Services</div>
        <div class="value" id="total-count">41</div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="grid">
      <!-- Services List -->
      <div class="panel">
        <h2>Active Services</h2>
        <div class="service-list" id="services-list">
          <div style="text-align: center; padding: 40px; color: #a0aec0;">
            Loading services...
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="panel">
        <h2>Recent Activity</h2>
        <div class="activity-feed" id="activity-feed">
          <div style="text-align: center; padding: 40px; color: #a0aec0;">
            Loading activity...
          </div>
        </div>
      </div>
    </div>

    <!-- WO Execution Progress -->
    <div class="panel">
      <h2>Work Order Execution Progress</h2>
      <div id="wo-progress">
        <div style="margin-bottom: 16px;">
          <strong>Phase 1:</strong> GD Sync Setup
          <div class="progress-bar">
            <div class="progress-fill" id="phase1-progress" style="width: 0%"></div>
          </div>
        </div>
        <div>
          <strong>Phase 2:</strong> Two-Way Sync + Mobile Access
          <div class="progress-bar">
            <div class="progress-fill" id="phase2-progress" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="panel">
      <h2>Live Logs (Last 20 lines)</h2>
      <div class="log-viewer" id="log-viewer">
        <div class="log-line">Initializing log viewer...</div>
      </div>
    </div>
  </div>

  <script>
    const SERVICES = {
      'autopilot': { priority: 1, desc: 'Work order processor' },
      'expense.ocr': { priority: 2, desc: 'Receipt OCR processing' },
      'localtruth': { priority: 3, desc: 'File system scanner' },
      'telegram-bridge': { priority: 4, desc: 'Telegram integration' },
      'cloudflared.dashboard': { priority: 5, desc: 'Dashboard tunnel' },
      'cloudflared.nas-archive': { priority: 6, desc: 'NAS tunnel' },
      'gg.memory.15m': { priority: 7, desc: 'Memory indexer (15min)' },
      'gg.weekly.integrity': { priority: 8, desc: 'Weekly integrity check' },
      'backup.gdrive': { priority: 9, desc: 'Google Drive backup' },
    };

    let activityLog = [];
    let refreshInterval;

    function addActivity(message) {
      const time = new Date().toLocaleTimeString();
      activityLog.unshift({ time, message });
      if (activityLog.length > 20) activityLog.pop();
      updateActivityFeed();
    }

    function updateActivityFeed() {
      const feed = document.getElementById('activity-feed');
      if (activityLog.length === 0) {
        feed.innerHTML = '<div style="text-align: center; padding: 40px; color: #a0aec0;">No recent activity</div>';
        return;
      }
      feed.innerHTML = activityLog.map(item => `
        <div class="activity-item">
          <span class="time">${item.time}</span>
          ${item.message}
        </div>
      `).join('');
    }

    async function fetchServiceStatus() {
      // Simulated data - in real implementation, this would call an API
      // that runs: launchctl list | grep "com.02luka"

      const mockServices = [
        { name: 'com.02luka.autopilot', pid: null, exit: 0 },
        { name: 'com.02luka.expense.ocr', pid: null, exit: 0 },
        { name: 'com.02luka.localtruth', pid: null, exit: 0 },
        { name: 'com.02luka.telegram-bridge', pid: 11594, exit: 0 },
        { name: 'com.02luka.cloudflared.dashboard', pid: 12975, exit: -15 },
        { name: 'com.02luka.cloudflared.nas-archive', pid: 13034, exit: -15 },
        { name: 'com.02luka.gg.memory.15m', pid: 53399, exit: 0 },
        { name: 'com.02luka.gg.weekly.integrity', pid: 53398, exit: 0 },
        { name: 'com.02luka.backup.gdrive', pid: null, exit: 11 },
      ];

      return mockServices;
    }

    function getServiceStatus(service) {
      if (service.pid && service.pid !== '-') {
        return { status: 'running', badge: 'running', dot: 'running' };
      } else if (service.exit === 0) {
        return { status: 'OnDemand', badge: 'ondemand', dot: 'ondemand' };
      } else if (service.exit > 0) {
        return { status: 'Error', badge: 'stopped', dot: 'error' };
      } else {
        return { status: 'Stopped', badge: 'stopped', dot: 'stopped' };
      }
    }

    async function refreshData() {
      const services = await fetchServiceStatus();

      let running = 0, ondemand = 0, stopped = 0;

      const serviceHTML = services.map(service => {
        const shortName = service.name.replace('com.02luka.', '');
        const statusInfo = getServiceStatus(service);

        if (statusInfo.status === 'running') running++;
        else if (statusInfo.status === 'OnDemand') ondemand++;
        else stopped++;

        const pidText = service.pid && service.pid !== '-' ? `PID: ${service.pid}` : '';
        const exitText = service.exit !== 0 ? `Exit: ${service.exit}` : '';

        return `
          <div class="service-item">
            <div class="status-dot ${statusInfo.dot}"></div>
            <div class="service-name">${shortName}</div>
            <div class="service-meta">
              <span class="badge ${statusInfo.badge}">${statusInfo.status}</span>
              ${pidText ? `<span>${pidText}</span>` : ''}
              ${exitText ? `<span>${exitText}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('services-list').innerHTML = serviceHTML;
      document.getElementById('running-count').textContent = running;
      document.getElementById('ondemand-count').textContent = ondemand;
      document.getElementById('stopped-count').textContent = stopped;
      document.getElementById('last-update').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

      // Check WO progress
      checkWOProgress();

      addActivity('System status refreshed');
    }

    async function checkWOProgress() {
      // In real implementation, check log files for WO completion
      // For now, simulate progress
      const now = Date.now();
      const startTime = 1730772000000; // Approximate start time
      const elapsed = now - startTime;

      // Phase 1: 0-10 minutes
      const phase1Progress = Math.min(100, (elapsed / (10 * 60 * 1000)) * 100);
      document.getElementById('phase1-progress').style.width = phase1Progress + '%';

      // Phase 2: starts after phase 1
      const phase2Progress = phase1Progress >= 100 ? Math.min(100, ((elapsed - (10 * 60 * 1000)) / (5 * 60 * 1000)) * 100) : 0;
      document.getElementById('phase2-progress').style.width = phase2Progress + '%';

      if (phase1Progress >= 100 && phase2Progress < 100) {
        addActivity('âœ… Phase 1 complete, Phase 2 in progress...');
      } else if (phase2Progress >= 100) {
        addActivity('ðŸŽ‰ Both phases complete!');
      }
    }

    // Initialize
    refreshData();
    refreshInterval = setInterval(refreshData, 30000); // Refresh every 30 seconds

    // Initial activities
    addActivity('Dashboard started');
    addActivity('Monitoring 41 services');
    addActivity('Auto-refresh enabled (30s interval)');
  </script>
</body>
</html>
