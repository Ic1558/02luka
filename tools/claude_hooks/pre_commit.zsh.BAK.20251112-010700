#!/usr/bin/env zsh
# Pre-commit fast guard (soft-fail). Never blocks work; only warns.
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
cd "$PROJECT_ROOT"

warns=0

banner() { printf "\n== %s ==\n" "$1"; }

banner "Pre-commit: quick hygiene checks (soft-fail)"

# 1) Shell syntax checks (if shellcheck present)
if command -v shellcheck >/dev/null 2>&1; then
  banner "Shellcheck (changed .zsh files)"
  changed_files=("${(@f)$(git diff --cached --name-only | grep -E '\.zsh$' || true)}")
  if [[ ${#changed_files[@]} -gt 0 ]]; then
    if ! shellcheck -x "${changed_files[@]}"; then
      echo "⚠️  shellcheck found issues"; warns=$((warns+1))
    else
      echo "✅ shellcheck OK"
    fi
  else
    echo "ℹ️  No staged .zsh files"
  fi
else
  echo "ℹ️  shellcheck not installed; skipping"
fi

# 2) Secret scan (very light-weight grep)
banner "Secret scan (light)"
patterns='(AKIA|ASIA|sk-(live|test)-|xox[baprs]-|-----BEGIN (RSA|EC) PRIVATE KEY-----)'
if git diff --cached -U0 | grep -E "$patterns" >/dev/null 2>&1; then
  echo "⚠️  Potential secret-like strings detected in staged changes"
  warns=$((warns+1))
else
  echo "✅ No obvious secrets in staged diff"
fi

# 3) Forbid set -x in prod scripts (tools/, .github/)
banner "Prod script trace guard"
if git diff --cached --name-only | grep -E '^(tools|\.github)/.*\.(zsh|sh|ya?ml)$' >/dev/null 2>&1; then
  if git diff --cached -U0 | grep -E '^[\+\s].*set -x' >/dev/null 2>&1; then
    echo "⚠️  Found 'set -x' in prod paths (tools/ or .github/). Please remove or guard by DEBUG."
    warns=$((warns+1))
  else
    echo "✅ No unguarded 'set -x' traces"
  fi
else
  echo "ℹ️  No prod-path scripts staged"
fi

# 4) Summary (always exit 0)
if (( warns > 0 )); then
  echo "\n⚠️  Pre-commit found ${warns} warning group(s). Commit allowed (soft-fail)."
else
  echo "\n✅ Pre-commit hygiene passed with no warnings."
fi

exit 0
